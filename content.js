(()=>{"use strict";function t(){const t="yt-hwv-styles";if(document.getElementById(t))return;const e=document.createElement("style");e.id=t,e.textContent="\n    .YT-HWV-WATCHED-HIDDEN { display: none !important }\n    .YT-HWV-WATCHED-DIMMED { opacity: 0.3 }\n    .YT-HWV-SHORTS-HIDDEN { display: none !important }\n    .YT-HWV-SHORTS-DIMMED { opacity: 0.3 }\n    .YT-HWV-HIDDEN-ROW-PARENT { padding-bottom: 10px }\n    .YT-HWV-INDIVIDUAL-HIDDEN { display: none !important }\n    .YT-HWV-INDIVIDUAL-DIMMED { opacity: 0.3 }\n\n    .yt-hwv-eye-button {\n      position: absolute !important;\n      top: 8px !important;\n      left: 50% !important;\n      transform: translateX(-50%) !important;\n      z-index: 999 !important;\n      background: rgba(0, 0, 0, 0.7) !important;\n      border: 1px solid rgba(255, 255, 255, 0.1) !important;\n      border-radius: 6px !important;\n      padding: 6px 8px !important;\n      cursor: pointer !important;\n      display: flex !important;\n      align-items: center !important;\n      justify-content: center !important;\n      transition: all 0.2s ease !important;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;\n      opacity: 0.3 !important;\n    }\n\n    .yt-hwv-eye-button:hover {\n      opacity: 1 !important;\n      background: rgba(0, 0, 0, 1) !important;\n      transform: translateX(-50%) scale(1.1) !important;\n      box-shadow: 0 4px 8px rgba(0,0,0,0.7) !important;\n    }\n\n    .yt-hwv-eye-button svg {\n      width: 20px !important;\n      height: 20px !important;\n      fill: white !important;\n      pointer-events: none !important;\n    }\n\n    .yt-hwv-eye-button.hidden svg {\n      fill: #ff4444 !important;\n    }\n\n    .yt-hwv-eye-button.dimmed svg {\n      fill: #ffaa00 !important;\n    }\n\n    ytd-thumbnail, yt-thumbnail-view-model, #dismissible, #thumbnail-container {\n      position: relative !important;\n    }\n  ",document.head.appendChild(e),function(){const t="yt-hwv-notification-styles";if(document.getElementById(t))return;const e=document.createElement("style");e.id=t,e.textContent='\n    .yt-hwv-notification-container {\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      z-index: 999999;\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n      max-width: 400px;\n    }\n\n    .yt-hwv-notification {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 12px 16px;\n      border-radius: 8px;\n      background: white;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n      opacity: 0;\n      transform: translateX(100%);\n      transition: all 0.3s ease;\n    }\n\n    .yt-hwv-notification.visible {\n      opacity: 1;\n      transform: translateX(0);\n    }\n\n    .yt-hwv-notification.error {\n      background: #fee;\n      border-left: 4px solid #c00;\n      color: #c00;\n    }\n\n    .yt-hwv-notification.warning {\n      background: #ffc;\n      border-left: 4px solid #fa0;\n      color: #a60;\n    }\n\n    .yt-hwv-notification.success {\n      background: #efe;\n      border-left: 4px solid #0a0;\n      color: #060;\n    }\n\n    .yt-hwv-notification.info {\n      background: #eef;\n      border-left: 4px solid #06c;\n      color: #048;\n    }\n\n    .notification-icon {\n      font-size: 20px;\n      font-weight: bold;\n    }\n\n    .notification-message {\n      flex: 1;\n      font-size: 14px;\n    }\n\n    .notification-close {\n      background: none;\n      border: none;\n      font-size: 20px;\n      cursor: pointer;\n      opacity: 0.6;\n      padding: 0;\n      width: 20px;\n      height: 20px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .notification-close:hover {\n      opacity: 1;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification {\n      background: #333;\n      color: #fff;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.error {\n      background: #400;\n      border-left-color: #f88;\n      color: #fcc;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.warning {\n      background: #440;\n      border-left-color: #fa0;\n      color: #ffc;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.success {\n      background: #040;\n      border-left-color: #0f0;\n      color: #cfc;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.info {\n      background: #004;\n      border-left-color: #09f;\n      color: #ccf;\n    }\n  ',document.head.appendChild(e)}()}const e="YTHWV_THRESHOLD",n="YTHWV_STATE",r="YTHWV_STATE_SHORTS",o="YTHWV_INDIVIDUAL_MODE",i="YTHWV_INDIVIDUAL_MODE_ENABLED",a="HIDDEN_VIDEOS_HEALTH_CHECK",s="HIDDEN_VIDEOS_GET_MANY",c="HIDDEN_VIDEOS_SET_STATE",d="YT-HWV-WATCHED-HIDDEN",l="YT-HWV-WATCHED-DIMMED",u="YT-HWV-SHORTS-HIDDEN",h="YT-HWV-SHORTS-DIMMED",f="YT-HWV-HIDDEN-ROW-PARENT",m="YT-HWV-INDIVIDUAL-HIDDEN",y="YT-HWV-INDIVIDUAL-DIMMED",p="yt-hwv-eye-button",E="yt-hwv-has-eye-button",v={PROGRESS_BAR:[".ytd-thumbnail-overlay-resume-playback-renderer",".ytThumbnailOverlayProgressBarHostWatchedProgressBarSegment",".ytp-progress-bar-played"],SHORTS_CONTAINERS:["ytd-reel-shelf-renderer","ytd-rich-shelf-renderer[is-shorts]","ytd-rich-section-renderer:has(ytd-rich-shelf-renderer[is-shorts])","ytm-shorts-lockup-view-model-v2","ytm-shorts-lockup-view-model","ytd-rich-item-renderer:has(.shortsLockupViewModelHost)",'ytd-rich-item-renderer:has(a[href^="/shorts/"])',".ytd-rich-shelf-renderer:has(a.reel-item-endpoint)",'ytd-video-renderer:has(.ytd-thumbnail-overlay-time-status-renderer[aria-label="Shorts"])','ytd-compact-video-renderer:has(a[href^="/shorts/"])','ytd-grid-video-renderer:has(a[href^="/shorts/"])'],THUMBNAILS:["yt-thumbnail-view-model:not(.yt-hwv-has-eye-button)","ytd-thumbnail:not(.yt-hwv-has-eye-button)"],VIDEO_CONTAINERS:["ytd-rich-item-renderer","ytd-video-renderer","ytd-grid-video-renderer","ytd-compact-video-renderer","yt-lockup-view-model","ytm-shorts-lockup-view-model"],TITLE_ELEMENTS:["#video-title","#video-title-link","a#video-title","h3.title","h3 a","h4 a",".title-and-badge a","ytm-shorts-lockup-view-model-v2 .shortsLockupViewModelHostTextContent","yt-formatted-string#video-title","span#video-title"]},g={VIDEO_CONTAINERS:v.VIDEO_CONTAINERS.join(", "),THUMBNAILS:v.THUMBNAILS.join(", "),SHORTS_CONTAINERS:v.SHORTS_CONTAINERS.join(", ")},w=!1,T=500,b=function(){const t={ROOT_MARGIN:"100px",THRESHOLD:[0,.25,.5],VISIBILITY_THRESHOLD:.25,BATCH_DELAY:100,ENABLE_LAZY_PROCESSING:!0};return Array.isArray(t.THRESHOLD)&&0!==t.THRESHOLD.length||(console.error("[YT-HWV] Invalid THRESHOLD config, using defaults"),t.THRESHOLD=[0,.25,.5]),t.THRESHOLD=t.THRESHOLD.filter(t=>"number"==typeof t&&t>=0&&t<=1),("number"!=typeof t.VISIBILITY_THRESHOLD||t.VISIBILITY_THRESHOLD<0||t.VISIBILITY_THRESHOLD>1)&&(console.error("[YT-HWV] Invalid VISIBILITY_THRESHOLD config, using default 0.25"),t.VISIBILITY_THRESHOLD=.25),("number"!=typeof t.BATCH_DELAY||t.BATCH_DELAY<0)&&(console.error("[YT-HWV] Invalid BATCH_DELAY config, using default 100ms"),t.BATCH_DELAY=100),t}();function I(...t){w}let S={threshold:10,watchedStates:{},shortsStates:{},individualMode:"dimmed",individualModeEnabled:!0};async function A(){const t=await chrome.storage.sync.get(null);S.threshold=t[e]||10,S.individualMode=t[o]||"dimmed",S.individualModeEnabled=void 0===t[i]||t[i];["misc","subscriptions","channel","watch","trending","playlist"].forEach(e=>{S.watchedStates[e]=t[`${n}_${e}`]||"normal","playlist"!==e&&(S.shortsStates[e]=t[`${r}_${e}`]||"normal")}),I()}function L(){return S.individualModeEnabled}const D=new Map,N=new Map,H=new Map,O=new Map;function R(t){return t&&Number.isFinite(t.updatedAt)?t.updatedAt:-1}function x(){if(D.size<=1e3)return;Array.from(H.entries()).sort((t,e)=>t[1]-e[1]).slice(0,D.size-1e3).forEach(([t])=>{D.delete(t),N.delete(t),H.delete(t)})}function _(t,e){if(t){if(e){const n=R(e);return D.set(t,e),N.set(t,-1===n?Date.now():n),H.set(t,Date.now()),void x()}D.delete(t),N.set(t,Date.now()),H.delete(t)}}function M(t,e){if(!t)return;const n=R(e);if(N.has(t)){if(n<=N.get(t))return void H.set(t,Date.now())}if(e)return D.set(t,e),N.set(t,-1===n?Date.now():n),H.set(t,Date.now()),void x();D.delete(t),H.delete(t)}function C(t){if(!t)return null;const e=D.get(t);return H.set(t,Date.now()),e||null}function V(){const{href:t}=window.location;return t.includes("/watch?")?"watch":t.match(/.*\/(user|channel|c)\/.+\/videos/u)||t.match(/.*\/@.*/u)?"channel":t.includes("/feed/subscriptions")?"subscriptions":t.includes("/feed/trending")?"trending":t.includes("/playlist?")?"playlist":"misc"}const Y=new WeakMap,k=new WeakMap,W=new WeakMap,B=new Map,P={hits:0,misses:0,invalidations:0};function $(t,e){if(!t||!e)return null;try{Y.has(t)||Y.set(t,new Map);const n=Y.get(t);if(n.has(e))return P.hits++,n.get(e);P.misses++;const r=t.closest(e);return n.set(e,r),r}catch(n){console.warn("[YT-HWV Cache] Error in cachedClosest:",n);try{return t.closest(e)}catch(t){return null}}}function q(t,e){if(!t||!e)return null;try{k.has(t)||k.set(t,new Map);const n=k.get(t);if(n.has(e))return P.hits++,n.get(e);P.misses++;const r=t.querySelector(e);return n.set(e,r),r}catch(n){console.warn("[YT-HWV Cache] Error in cachedQuerySelector:",n);try{return t.querySelector(e)}catch(t){return null}}}function U(t,e=1e3){if(!t)return[];try{const n=Date.now();B.size>100&&function(){const t=Date.now(),e=[];for(const[n,r]of B.entries())t-r.timestamp>1e3&&e.push(n);e.forEach(t=>{B.delete(t)})}();const r=B.get(t);if(r&&n-r.timestamp<e)return P.hits++,r.results;P.misses++;const o=Array.from(document.querySelectorAll(t));return B.set(t,{results:o,timestamp:n}),o}catch(e){console.warn("[YT-HWV Cache] Error in cachedDocumentQuery:",e);try{return Array.from(document.querySelectorAll(t))}catch(t){return[]}}}function z(){[/ytd-rich-item-renderer/,/ytd-video-renderer/,/ytd-grid-video-renderer/,/ytd-compact-video-renderer/,/yt-thumbnail/,/progress.*bar/i,/watch\?v=/,/shorts\//].forEach(t=>{!function(t){if(!t)return B.clear(),void P.invalidations++;if("string"==typeof t)B.delete(t),P.invalidations++;else if(t instanceof RegExp){const e=[];for(const n of B.keys())t.test(n)&&e.push(n);e.forEach(t=>B.delete(t)),e.length>0&&P.invalidations++}}(t)})}function j(){B.clear(),P.invalidations++}function G(t){if(!t)return null;const e=t.match(/\/watch\?v=([^&]+)/);if(e)return e[1];const n=t.match(/\/shorts\/([^?]+)/);return n?n[1]:null}function X(t){if(!t)return"";for(const e of v.TITLE_ELEMENTS){const n=q(t,e);if(n&&!n.classList.contains(p)){const t=n.getAttribute("title")||n.getAttribute("aria-label")||n.textContent?.trim()||"";return t?t.includes(" - ")?t.split(" - ")[0]:t.includes(" by ")?t.split(" by ")[0]:t:""}}return""}function Z(){const t=[],e=new Set;v.PROGRESS_BAR.forEach(n=>{U(n,T).forEach(n=>{e.has(n)||(e.add(n),t.push(n))})});const n=S.threshold,r=t.filter(t=>t.style.width&&parseInt(t.style.width,10)>=n);return I((t.length,r.length)),r}function K(...t){t.forEach(t=>{!function(t){document.querySelectorAll(`.${t}`).forEach(e=>{e.classList.remove(t)})}(t)})}function F(){if(K(l,d),window.location.href.indexOf("/feed/history")>=0)return;const t=V(),e=function(t){return S.watchedStates[t]}(t)||"normal";"normal"!==e&&Z().forEach(n=>{let r,o;if("subscriptions"===t)r=$(n,".ytd-grid-renderer")||$(n,".ytd-item-section-renderer")||$(n,".ytd-rich-grid-row")||$(n,".ytd-rich-grid-renderer")||$(n,"#grid-container"),r?.classList.contains("ytd-item-section-renderer")&&$(r,"ytd-item-section-renderer")?.classList.add(f);else if("playlist"===t)r=$(n,"ytd-playlist-video-renderer");else if("watch"===t){r=$(n,"ytd-compact-video-renderer"),$(r,"ytd-compact-autoplay-renderer")&&(r=null);const t=$(n,"ytd-playlist-panel-video-renderer");!r&&t&&(o=t)}else r=$(n,"ytd-rich-item-renderer")||$(n,"ytd-video-renderer")||$(n,"ytd-grid-video-renderer")||$(n,"ytm-video-with-context-renderer")||$(n,"ytm-item-section-renderer");r&&("dimmed"===e?r.classList.add(l):"hidden"===e&&r.classList.add(d)),!o||"dimmed"!==e&&"hidden"!==e||o.classList.add(l)})}function Q(){K(h,u);const t=function(t){return S.shortsStates[t]}(V())||"normal";if("normal"===t)return;(function(){const t=[],e=new Set;return v.SHORTS_CONTAINERS.forEach(n=>{try{U(n).forEach(n=>{const r=n.tagName+n.className;if(!e.has(r)){e.add(r);const o=$(n,"ytd-reel-shelf-renderer")||$(n,"ytd-rich-shelf-renderer")||$(n,"ytd-rich-section-renderer");o&&!t.includes(o)?t.push(o):o||t.includes(n)||t.push(n)}})}catch(t){I()}}),U('a.reel-item-endpoint, a[href^="/shorts/"]').forEach(e=>{const n=$(e,"ytd-rich-item-renderer")||$(e,"ytd-video-renderer")||$(e,"ytd-compact-video-renderer")||$(e,"ytd-grid-video-renderer");n&&!t.includes(n)&&t.push(n)}),U('.ytd-thumbnail-overlay-time-status-renderer[aria-label="Shorts"]').forEach(e=>{const n=$(e,"ytd-video-renderer")||$(e,"ytd-compact-video-renderer")||$(e,"ytd-grid-video-renderer");n&&!t.includes(n)&&t.push(n)}),U("ytd-rich-shelf-renderer").forEach(e=>{(q(e,'a[href^="/shorts/"]')||q(e,".reel-item-endpoint")||q(e,".shortsLockupViewModelHost"))&&!t.includes(e)&&t.push(e)}),I(t.length),t})().forEach(e=>{"dimmed"===t?e.classList.add(h):"hidden"===t&&e.classList.add(u)})}const J={TRANSIENT:"transient",QUOTA_EXCEEDED:"quota",PERMISSION:"permission",CORRUPTION:"corruption",NETWORK:"network",PERMANENT:"permanent"};function tt(t){if(!t)return J.PERMANENT;const e=t.message?.toLowerCase()||"",n=t.name?.toLowerCase()||"";return e.includes("quota")||n.includes("quotaexceedederror")?J.QUOTA_EXCEEDED:e.includes("transaction")||e.includes("aborted")||e.includes("busy")||n.includes("aborterror")?J.TRANSIENT:e.includes("extension context invalidated")||e.includes("context invalidated")?J.PERMANENT:e.includes("message")||e.includes("no response")||e.includes("no receiver")||e.includes("disconnected")||e.includes("timeout")||e.includes("could not establish connection")||e.includes("receiving end does not exist")?J.NETWORK:e.includes("permission")||n.includes("securityerror")?J.PERMISSION:e.includes("corrupt")||e.includes("invalid")||n.includes("dataerror")?J.CORRUPTION:J.PERMANENT}const et=[];function nt(t,e,n={}){const r={timestamp:Date.now(),context:t,type:tt(e),message:e?.message||String(e),metadata:n};return et.unshift(r),et.length>100&&et.pop(),console.error(`[${t}]`,e,n),r}let rt=!1;function ot(){if(rt)return!1;try{const t=chrome.runtime?.id;return!!t}catch(t){return rt=!0,!1}}async function it(t,e={}){return ot()?async function(t,e={}){const{maxAttempts:n=3,initialDelay:r=100,maxDelay:o=5e3,shouldRetry:i=t=>tt(t)===J.TRANSIENT,onRetry:a=null}=e;let s,c=r;for(let e=1;e<=n;e++)try{return await t()}catch(t){if(s=t,e===n||!i(t))throw t;a&&a(e,t),await new Promise(t=>setTimeout(t,c)),c=Math.min(2*c,o)}throw s}(async()=>{try{const n=await function(t,e=5e3){return ot()?Promise.race([chrome.runtime.sendMessage(t),new Promise((t,n)=>setTimeout(()=>n(new Error("Message timeout")),e))]).catch(t=>{const e=t?.message?.toLowerCase()||"";throw(e.includes("extension context invalidated")||e.includes("context invalidated"))&&(rt=!0),t}):Promise.reject(new Error("Extension context invalidated"))}({type:t,...e});if(!n)throw new Error("No response from background script");if(!n.ok){const t=new Error(n.error||"hidden video message failed");throw t.response=n,t}return n.result}catch(n){throw tt(n)===J.PERMANENT&&n.message?.includes("context invalidated")||nt("Messaging",n,{type:t,payload:e}),n}},{maxAttempts:5,initialDelay:300,maxDelay:3e3,shouldRetry:t=>{const e=tt(t);return e===J.NETWORK||e===J.TRANSIENT}}):Promise.reject(new Error("Extension context invalidated"))}const at="info",st=new Map;function ct(t,e=at,n=3e3){const r=function(){let t=document.getElementById("yt-hwv-notifications");t||(t=document.createElement("div"),t.id="yt-hwv-notifications",t.className="yt-hwv-notification-container",document.body.appendChild(t));return t}(),o=function(t,e){const n=document.createElement("div");n.className=`yt-hwv-notification ${e}`;const r=function(t){const e={error:"⚠",warning:"⚠",success:"✓",info:"ℹ"};return e[t]||e.info}(e),o=document.createElement("div");o.className="notification-icon",o.textContent=r;const i=document.createElement("div");i.className="notification-message",i.textContent=t;const a=document.createElement("button");return a.className="notification-close",a.setAttribute("aria-label","Close"),a.textContent="×",n.appendChild(o),n.appendChild(i),n.appendChild(a),a.addEventListener("click",()=>{dt(null,n)}),n}(t,e);r.appendChild(o);const i=Date.now()+Math.random();return st.set(i,o),requestAnimationFrame(()=>{o.classList.add("visible")}),n>0&&setTimeout(()=>{dt(i,o)},n),i}function dt(t,e){e.classList.remove("visible"),setTimeout(()=>{e.remove(),t&&st.delete(t)},300)}async function lt(t){const e=Array.isArray(t)?t.filter(Boolean):[];if(0===e.length)return{};const n=Array.from(new Set(e)),r={},o=[],i=[];if(n.forEach(t=>{!function(t){return D.has(t)}(t)?!function(t){return O.has(t)}(t)?o.push(t):i.push(function(t){return O.get(t)}(t).then(e=>{r[t]=e}).catch(()=>{o.push(t)})):r[t]=C(t)}),o.length>0){const t=it(s,{ids:o}).then(t=>{const e=t.records||{};return o.forEach(t=>{M(t,e[t]||null),r[t]=C(t)}),e}).catch(t=>{throw nt("ContentMessaging",t,{operation:"fetchHiddenVideoStates",videoCount:o.length}),o.forEach(t=>{M(t,null),r[t]=null}),t}).finally(()=>{o.forEach(t=>function(t){O.delete(t)}(t))});o.forEach(e=>{const n=t.then(()=>C(e)).catch(()=>null);!function(t,e){O.set(t,e)}(e,n),i.push(n.then(t=>{r[e]=t}))})}return i.length>0&&await Promise.allSettled(i),r}async function ut(t,e,n){const r=t?String(t).trim():"";if(!r)return null;const o={videoId:r,state:e,title:n||"",updatedAt:Date.now()};_(r,"normal"===e?null:o);const i={videoId:r,state:e,title:n||""};try{const t=await it(c,i);return t&&t.record?(_(r,t.record),t.record):(_(r,null),null)}catch(t){nt("ContentMessaging",t,{operation:"setHiddenVideoState",videoId:r,state:e});const n=tt(t);if("undefined"!=typeof document&&document.body){ct(n===J.NETWORK?"Unable to connect to extension. Please check your connection.":"Failed to save video state. Please try again.","error",3e3)}throw _(r,null),t}}function ht(t,e){t&&(t.classList.remove("dimmed","hidden"),"dimmed"===e?t.classList.add("dimmed"):"hidden"===e&&t.classList.add("hidden"))}function ft(t,e){if(!e)return null;const n=document.createElement("button");n.className=p,n.setAttribute("data-video-id",e),n.setAttribute("tabindex","-1"),n.setAttribute("aria-label","Toggle video visibility");const r=C(e);return ht(n,r?.state||"normal"),r||lt([e]).then(()=>{const t=C(e);ht(n,t?.state||"normal")}).catch(()=>{}),n.innerHTML='\n    <svg viewBox="0 0 24 24">\n      <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>\n    </svg>\n  ',n.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation();const r=C(e),o="normal"===(r?.state||"normal")?S.individualMode:"normal",i=$(n,g.VIDEO_CONTAINERS);i&&i.setAttribute("data-ythwv-video-id",e);const a=X(i),s=await async function(t,e,n=null){return t?ut(t,e,n||void 0):null}(e,o,a),c=s?s.state:"normal";ht(n,c),i&&(i.classList.remove(y,m),"dimmed"===c?i.classList.add(y):"hidden"===c&&i.classList.add(m));const d=new CustomEvent("yt-hwv-individual-update");document.dispatchEvent(d)}),n}function mt(){if(!L()){U(`.${p}`).forEach(t=>t.remove());return void U(`.${E}`).forEach(t=>t.classList.remove(E))}const t=U(v.THUMBNAILS.join(", "));I(t.length),t.forEach(t=>{if(q(t,`.${p}`))return;const e=$(t,"a")||q(t,"a");if(!e)return;const n=e.getAttribute("href");if(!n)return;let r=null;const o=n.match(/\/watch\?v=([^&]+)/),i=n.match(/\/shorts\/([^?]+)/);if(o?r=o[1]:i&&(r=i[1]),!r)return;const a=ft(0,r);if(!a)return;t.style.position="relative",t.appendChild(a),t.classList.add(E),t.setAttribute("data-ythwv-video-id",r);const s=$(t,v.VIDEO_CONTAINERS.join(", "));s&&s.setAttribute("data-ythwv-video-id",r),lt([r]).then(()=>{const e=C(r);if(!e||e.title)return;const n=$(t,v.VIDEO_CONTAINERS.join(", "));n&&n.setAttribute("data-ythwv-video-id",r);const o=X(n);o&&"Toggle video visibility"!==o&&async function(t,e,n=null){t&&ut(t,e,n||void 0)}(r,e.state,o)}).catch(()=>{}),I()}),document.querySelectorAll(`.${p}`).forEach(t=>{const e=t.closest('[aria-hidden="true"]');e&&e.removeAttribute("aria-hidden")})}const yt=new Set,pt=new Set;function Et(t){return t.isIntersecting&&t.intersectionRatio>=b.VISIBILITY_THRESHOLD}function vt(t,e){pt.forEach(n=>{try{n({becameVisible:t,becameHidden:e})}catch(t){I()}})}function gt(){return new Set(yt)}function wt(t){if(!Array.isArray(t)||0===t.length)return;const e=[],n=[];t.forEach(t=>{const r=t.target,o=Et(t);o&&function(t){return!yt.has(t)&&(yt.add(t),!0)}(r)?e.push(r):!o&&function(t){return yt.delete(t)}(r)&&n.push(r)}),(e.length>0||n.length>0)&&(I((e.length,n.length)),vt(e,n))}let Tt=0,bt=!0;async function It(){if(!L())return void document.querySelectorAll(`.${y}, .${m}`).forEach(t=>{t.classList.remove(y,m)});I(),I(),I(b.ENABLE_LAZY_PROCESSING),I(gt().size),Tt+=1;const t=Tt;let e;if(b.ENABLE_LAZY_PROCESSING&&!bt){const t=gt(),n=new Set;t.forEach(t=>{if(t&&t.isConnected)try{const e=t.getAttribute("data-ythwv-video-id");e&&n.add(e);t.querySelectorAll('a[href*="/watch?v="], a[href*="/shorts/"]').forEach(t=>{const e=t.getAttribute("href");if(e){const t=G(e);t&&n.add(t)}})}catch(t){I()}}),e=Array.from(n),I(e.length)}else e=function(){const t=new Set;return U("[data-ythwv-video-id]").forEach(e=>{const n=e.getAttribute("data-ythwv-video-id");n&&t.add(n)}),U('a[href*="/watch?v="], a[href*="/shorts/"]').forEach(e=>{const n=G(e.getAttribute("href"));n&&t.add(n)}),Array.from(t)}(),I(e.length);if(0!==e.length){try{await lt(e)}catch(t){return void I()}t===Tt&&(e.forEach(t=>{const e=C(t),n=e?.state||"normal",r=function(t){const e=new Set;return U(`.${p}[data-video-id="${t}"]`).forEach(t=>{const n=$(t,g.VIDEO_CONTAINERS);n&&e.add(n)}),U(`a[href*="/watch?v=${t}"], a[href*="/shorts/${t}"]`).forEach(t=>{const n=$(t,g.VIDEO_CONTAINERS);n&&e.add(n)}),Array.from(e)}(t);r.forEach(t=>{var e;(!b.ENABLE_LAZY_PROCESSING||bt||(e=t,yt.has(e)))&&function(t,e){if(!t)return;const n=t.classList.contains(y),r=t.classList.contains(m);"dimmed"===e?(r&&t.classList.remove(m),n||t.classList.add(y)):"hidden"===e?(n&&t.classList.remove(y),r||t.classList.add(m)):(n&&t.classList.remove(y),r&&t.classList.remove(m))}(t,n)})}),bt&&(bt=!1,I()))}}function St(t){if(t&&t.type)return"updated"===t.type&&t.record?(_(t.record.videoId,t.record),document.querySelectorAll(`.${p}[data-video-id="${t.record.videoId}"]`).forEach(e=>{ht(e,t.record.state)}),void It()):"removed"===t.type&&t.videoId?(_(t.videoId,null),document.querySelectorAll(`.${p}[data-video-id="${t.videoId}"]`).forEach(t=>{ht(t,"normal")}),void It()):void("cleared"===t.type&&(D.clear(),N.clear(),H.clear(),document.querySelectorAll(`.${p}`).forEach(t=>{ht(t,"normal")}),It()))}function At(){I(),F(),Q(),setTimeout(()=>{mt(),It()},500)}let Lt=null;function Dt(){var t;chrome.runtime.onMessage.addListener(async(t,e,n)=>{"settingsUpdated"===t.action||"resetSettings"===t.action?(await A(),At()):"HIDDEN_VIDEOS_EVENT"===t.type&&St(t.event)}),document.addEventListener("yt-hwv-individual-update",()=>{It()}),b.ENABLE_LAZY_PROCESSING?(t=({becameVisible:t,becameHidden:e})=>{t.length>0&&(I(t.length),It())},pt.add(t),Lt=()=>pt.delete(t)):I()}function Nt(){Lt&&(Lt(),Lt=null)}function Ht(t,e){let n;const r=function(...r){clearTimeout(n),n=setTimeout(()=>t.apply(this,r),e)};return r.cancel=function(){clearTimeout(n),n=null},r}let Ot=null,Rt=null,xt=[];function _t(t=null){if(!Ot)return void I();const e=t||U(g.VIDEO_CONTAINERS);e.forEach(t=>{try{Ot.observe(t)}catch(t){I()}}),I(e.length)}function Mt(){return b.ENABLE_LAZY_PROCESSING?(Ct(),Ot=function(){const t={root:null,rootMargin:b.ROOT_MARGIN,threshold:b.THRESHOLD};Rt=Ht(()=>{xt.length>0&&(wt([...xt]),xt.length=0)},b.BATCH_DELAY);const e=new IntersectionObserver(t=>{xt.push(...t),Rt()},t);return I(),e}(),_t(),Ot):(I(),null)}function Ct(){Ot&&(Ot.disconnect(),Ot=null,yt.clear(),I()),xt.length=0,Rt&&"function"==typeof Rt.cancel&&Rt.cancel(),Rt=null}function Vt(t){const e=Ht(t,250),n=new MutationObserver(t=>{let n=!1,r=!1,o=!1;const i=[],a=[];var s;if(t.forEach(t=>{if("attributes"===t.type&&"aria-hidden"===t.attributeName){const e=t.target;"true"===e.getAttribute("aria-hidden")&&e.querySelector(`.${p}`)&&e.removeAttribute("aria-hidden")}else"childList"===t.type&&(n=!0,t.removedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){!function(t){if(!t)return;const e=Y.get(t);e&&e.clear();const n=k.get(t);n&&n.clear();const r=W.get(t);r&&r.clear(),Y.delete(t),k.delete(t),W.delete(t),P.invalidations++}(t);t.matches&&(t.matches("ytd-rich-item-renderer")||t.matches("ytd-video-renderer")||t.matches("ytd-grid-video-renderer")||t.matches("ytd-compact-video-renderer"))&&(r=!0,a.push(t))}}),t.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){t.matches&&(t.matches("ytd-rich-item-renderer")||t.matches("ytd-video-renderer")||t.matches("ytd-grid-video-renderer")||t.matches("ytd-compact-video-renderer"))&&(r=!0,i.push(t));t.matches&&(t.matches("ytd-browse")||t.matches("ytd-watch-flexy")||t.matches("ytd-search"))&&(o=!0)}}))}),i.length>0&&_t(i),a.length>0&&(s=a,Ot&&s.forEach(t=>{try{Ot.unobserve(t)}catch(t){I()}})),o?j():r&&z(),n){if(1===t.length&&(t[0].target.classList?.contains(l)||t[0].target.classList?.contains(d)||t[0].target.classList?.contains(h)||t[0].target.classList?.contains(u)))return;e()}});return n.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-hidden"]}),n}function Yt(t){const e=Ht(t,100);let n=location.href;const r=new MutationObserver(()=>{const t=location.href;t!==n&&(j(),Ct(),Mt(),n=t,setTimeout(e,100))});return r.observe(document,{subtree:!0,childList:!0}),r}async function kt(){try{await async function(t=10,e=500){for(let n=1;n<=t;n++){try{const t=await it(a,{});if(t&&t.ready)return!0;t&&t.error&&nt("ContentInit",new Error("Background initialization error: "+t.error))}catch(e){nt("ContentInit",e,{attempt:n,maxAttempts:t,message:"Health check failed, retrying..."})}n<t&&await new Promise(t=>setTimeout(t,e))}return!1}()||console.warn("[YT-HWV] Background script not ready, starting with limited functionality. Individual video hiding/dimming may not work until background service is ready.");try{t()}catch(t){throw nt("ContentInit",t,{component:"styles",fatal:!0}),"undefined"!=typeof document&&document.body&&ct("YouTube Hide Watched Videos failed to load styles","error",5e3),t}await A(),Mt(),At(),Vt(At),function(t){const e=Ht(t,100),n=XMLHttpRequest.prototype.open,r=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(t,e){return this._url=e,n.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){return this.addEventListener("readystatechange",function(){4===this.readyState&&this._url&&(this._url.includes("browse_ajax")||this._url.includes("browse?"))&&setTimeout(e,100)}),r.apply(this,arguments)}}(At),Yt(At),Dt()}catch(t){nt("ContentInit",t,{fatal:!0}),"undefined"!=typeof document&&document.body&&ct("YouTube Hide Watched Videos extension failed to initialize","error",5e3)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",kt):kt(),"undefined"!=typeof window&&(window.addEventListener("beforeunload",()=>{Ct(),Nt()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&Ct()}),window.addEventListener("pagehide",()=>{Ct(),Nt()})),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onSuspend?.addListener(()=>{Ct(),Nt()}),I()})();
//# sourceMappingURL=content.js.map