(()=>{"use strict";function e(){const e="yt-hwv-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent="\n    .YT-HWV-WATCHED-HIDDEN { display: none !important }\n    .YT-HWV-WATCHED-DIMMED { opacity: 0.3 }\n    .YT-HWV-SHORTS-HIDDEN { display: none !important }\n    .YT-HWV-SHORTS-DIMMED { opacity: 0.3 }\n    .YT-HWV-HIDDEN-ROW-PARENT { padding-bottom: 10px }\n    .YT-HWV-INDIVIDUAL-HIDDEN { display: none !important }\n    .YT-HWV-INDIVIDUAL-DIMMED { opacity: 0.3 }\n\n    .yt-hwv-eye-button {\n      position: absolute !important;\n      top: 8px !important;\n      left: 50% !important;\n      transform: translateX(-50%) !important;\n      z-index: 999 !important;\n      background: rgba(0, 0, 0, 0.7) !important;\n      border: 1px solid rgba(255, 255, 255, 0.1) !important;\n      border-radius: 6px !important;\n      padding: 6px 8px !important;\n      cursor: pointer !important;\n      display: flex !important;\n      align-items: center !important;\n      justify-content: center !important;\n      transition: all 0.2s ease !important;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;\n      opacity: 0.3 !important;\n    }\n\n    .yt-hwv-eye-button:hover {\n      opacity: 1 !important;\n      background: rgba(0, 0, 0, 1) !important;\n      transform: translateX(-50%) scale(1.1) !important;\n      box-shadow: 0 4px 8px rgba(0,0,0,0.7) !important;\n    }\n\n    .yt-hwv-eye-button svg {\n      width: 20px !important;\n      height: 20px !important;\n      fill: white !important;\n      pointer-events: none !important;\n    }\n\n    .yt-hwv-eye-button.hidden svg {\n      fill: #ff4444 !important;\n    }\n\n    .yt-hwv-eye-button.dimmed svg {\n      fill: #ffaa00 !important;\n    }\n\n    ytd-thumbnail, yt-thumbnail-view-model, #dismissible, #thumbnail-container {\n      position: relative !important;\n    }\n  ",document.head.appendChild(t),function(){const e="yt-hwv-notification-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent='\n    .yt-hwv-notification-container {\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      z-index: 999999;\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n      max-width: 400px;\n    }\n\n    .yt-hwv-notification {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 12px 16px;\n      border-radius: 8px;\n      background: white;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n      opacity: 0;\n      transform: translateX(100%);\n      transition: all 0.3s ease;\n    }\n\n    .yt-hwv-notification.visible {\n      opacity: 1;\n      transform: translateX(0);\n    }\n\n    .yt-hwv-notification.error {\n      background: #fee;\n      border-left: 4px solid #c00;\n      color: #c00;\n    }\n\n    .yt-hwv-notification.warning {\n      background: #ffc;\n      border-left: 4px solid #fa0;\n      color: #a60;\n    }\n\n    .yt-hwv-notification.success {\n      background: #efe;\n      border-left: 4px solid #0a0;\n      color: #060;\n    }\n\n    .yt-hwv-notification.info {\n      background: #eef;\n      border-left: 4px solid #06c;\n      color: #048;\n    }\n\n    .notification-icon {\n      font-size: 20px;\n      font-weight: bold;\n    }\n\n    .notification-message {\n      flex: 1;\n      font-size: 14px;\n    }\n\n    .notification-close {\n      background: none;\n      border: none;\n      font-size: 20px;\n      cursor: pointer;\n      opacity: 0.6;\n      padding: 0;\n      width: 20px;\n      height: 20px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .notification-close:hover {\n      opacity: 1;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification {\n      background: #333;\n      color: #fff;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.error {\n      background: #400;\n      border-left-color: #f88;\n      color: #fcc;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.warning {\n      background: #440;\n      border-left-color: #fa0;\n      color: #ffc;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.success {\n      background: #040;\n      border-left-color: #0f0;\n      color: #cfc;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.info {\n      background: #004;\n      border-left-color: #09f;\n      color: #ccf;\n    }\n  ',document.head.appendChild(t)}()}const t="YTHWV_THRESHOLD",n="YTHWV_STATE",i="YTHWV_STATE_SHORTS",r="YTHWV_INDIVIDUAL_MODE",o="YTHWV_INDIVIDUAL_MODE_ENABLED",a="HIDDEN_VIDEOS_HEALTH_CHECK",s="HIDDEN_VIDEOS_GET_MANY",c="HIDDEN_VIDEOS_SET_STATE",d="YT-HWV-WATCHED-HIDDEN",l="YT-HWV-WATCHED-DIMMED",u="YT-HWV-SHORTS-HIDDEN",h="YT-HWV-SHORTS-DIMMED",m="YT-HWV-HIDDEN-ROW-PARENT",f="YT-HWV-INDIVIDUAL-HIDDEN",y="YT-HWV-INDIVIDUAL-DIMMED",p="yt-hwv-eye-button",E="yt-hwv-has-eye-button",v={PROGRESS_BAR:[".ytd-thumbnail-overlay-resume-playback-renderer",".ytThumbnailOverlayProgressBarHostWatchedProgressBarSegment",".ytp-progress-bar-played"],SHORTS_CONTAINERS:["ytd-reel-shelf-renderer","ytd-rich-shelf-renderer[is-shorts]","ytd-rich-section-renderer:has(ytd-rich-shelf-renderer[is-shorts])","ytm-shorts-lockup-view-model-v2","ytm-shorts-lockup-view-model","ytd-rich-item-renderer:has(.shortsLockupViewModelHost)",'ytd-rich-item-renderer:has(a[href^="/shorts/"])',".ytd-rich-shelf-renderer:has(a.reel-item-endpoint)",'ytd-video-renderer:has(.ytd-thumbnail-overlay-time-status-renderer[aria-label="Shorts"])','ytd-compact-video-renderer:has(a[href^="/shorts/"])','ytd-grid-video-renderer:has(a[href^="/shorts/"])'],THUMBNAILS:["yt-thumbnail-view-model:not(.yt-hwv-has-eye-button)","ytd-thumbnail:not(.yt-hwv-has-eye-button)"],VIDEO_CONTAINERS:["ytd-rich-item-renderer","ytd-video-renderer","ytd-grid-video-renderer","ytd-compact-video-renderer","yt-lockup-view-model","ytm-shorts-lockup-view-model"],TITLE_ELEMENTS:["#video-title","#video-title-link","a#video-title","h3.title","h3 a","h4 a",".title-and-badge a","ytm-shorts-lockup-view-model-v2 .shortsLockupViewModelHostTextContent","yt-formatted-string#video-title","span#video-title"]},g={VIDEO_CONTAINERS:v.VIDEO_CONTAINERS.join(", "),THUMBNAILS:v.THUMBNAILS.join(", "),SHORTS_CONTAINERS:v.SHORTS_CONTAINERS.join(", ")},w=!1,T=500,b=function(){const e={ROOT_MARGIN:"100px",THRESHOLD:[0,.25,.5],VISIBILITY_THRESHOLD:.25,BATCH_DELAY:100,ENABLE_LAZY_PROCESSING:!0};return Array.isArray(e.THRESHOLD)&&0!==e.THRESHOLD.length||(console.error("[YT-HWV] Invalid THRESHOLD config, using defaults"),e.THRESHOLD=[0,.25,.5]),e.THRESHOLD=e.THRESHOLD.filter(e=>"number"==typeof e&&e>=0&&e<=1),("number"!=typeof e.VISIBILITY_THRESHOLD||e.VISIBILITY_THRESHOLD<0||e.VISIBILITY_THRESHOLD>1)&&(console.error("[YT-HWV] Invalid VISIBILITY_THRESHOLD config, using default 0.25"),e.VISIBILITY_THRESHOLD=.25),("number"!=typeof e.BATCH_DELAY||e.BATCH_DELAY<0)&&(console.error("[YT-HWV] Invalid BATCH_DELAY config, using default 100ms"),e.BATCH_DELAY=100),e}(),S={VIDEO_TITLE:["#video-title","#video-title-link","a#video-title","h3.title a","h3 a","h4 a",".title-and-badge a","yt-formatted-string#video-title","span#video-title",'a[href*="/watch?v="]','a[href*="/shorts/"]'],PROGRESS_BAR:[".ytd-thumbnail-overlay-resume-playback-renderer",".yt-thumbnail-overlay-resume-playback-renderer-wiz__progress-bar",".ytThumbnailOverlayProgressBarHostWatchedProgressBarSegment",".ytp-progress-bar-played","yt-thumbnail-overlay-resume-playback-renderer",".ytm-thumbnail-overlay-resume-playback-renderer",'[class*="progress"][class*="bar"]','[class*="watched"]'],VIDEO_THUMBNAIL:["yt-thumbnail-view-model","ytd-thumbnail",".ytThumbnailViewModelImage","img.yt-core-image",'[class*="thumbnail"]'],VIDEO_LINK:['a[href*="/watch?v="]','a[href^="/watch?"]','a[href*="&v="]',"a.ytd-thumbnail","a.yt-simple-endpoint"],SHORTS_LINK:['a[href*="/shorts/"]','a[href^="/shorts/"]',"a.reel-item-endpoint",".shortsLockupViewModelHost a"],VIDEO_CONTAINERS:["ytd-rich-item-renderer","ytd-video-renderer","ytd-grid-video-renderer","ytd-compact-video-renderer","yt-lockup-view-model","ytm-shorts-lockup-view-model"],THUMBNAILS:["yt-thumbnail-view-model:not(.yt-hwv-has-eye-button)","ytd-thumbnail:not(.yt-hwv-has-eye-button)"]},I=3e4,A=3e5;function H(...e){w}let N={threshold:10,watchedStates:{},shortsStates:{},individualMode:"dimmed",individualModeEnabled:!0};async function L(){const e=await chrome.storage.sync.get(null);N.threshold=e[t]||10,N.individualMode=e[r]||"dimmed",N.individualModeEnabled=void 0===e[o]||e[o];["misc","subscriptions","channel","watch","trending","playlist"].forEach(t=>{N.watchedStates[t]=e[`${n}_${t}`]||"normal","playlist"!==t&&(N.shortsStates[t]=e[`${i}_${t}`]||"normal")}),H()}function O(){return N.individualModeEnabled}const D=new Map,C=new Map,x=new Map,M=new Map,R=new class{constructor({maxSize:e,mainCache:t,accessOrderMap:n,auxiliaryMaps:i=[],cacheName:r="Cache"}){this.maxSize=e,this.mainCache=t,this.accessOrderMap=n,this.auxiliaryMaps=i,this.cacheName=r,this.isEvicting=!1}evictLRUEntries(){if(!(this.mainCache.size<=this.maxSize||this.isEvicting))try{if(this.isEvicting=!0,this.mainCache.size<=this.maxSize)return;const e=Array.from(this.accessOrderMap.entries()).sort((e,t)=>e[1]-t[1]),t=this.mainCache.size-this.maxSize,n=e.slice(0,t);n.map(([e])=>e).forEach(e=>{this.mainCache.delete(e),this.accessOrderMap.delete(e),this.auxiliaryMaps.forEach(t=>t.delete(e))});const i=[this.mainCache,...this.auxiliaryMaps].map(e=>e.size);i.every(e=>e===this.mainCache.size)||console.error(`[${this.cacheName}] Inconsistency detected after eviction:`,"mainCache size:",this.mainCache.size,"auxiliary sizes:",this.auxiliaryMaps.map(e=>e.size))}finally{this.isEvicting=!1}}updateAccessTime(e){this.accessOrderMap.set(e,Date.now())}removeEntry(e){this.mainCache.delete(e),this.accessOrderMap.delete(e),this.auxiliaryMaps.forEach(t=>t.delete(e))}clear(){this.isEvicting=!1,this.mainCache.clear(),this.accessOrderMap.clear(),this.auxiliaryMaps.forEach(e=>e.clear())}validateConsistency(){const e=[];this.auxiliaryMaps.forEach((t,n)=>{this.mainCache.size!==t.size&&e.push({type:"size_mismatch",message:`mainCache size (${this.mainCache.size}) !== auxiliary map ${n} size (${t.size})`})});for(const t of this.mainCache.keys())this.auxiliaryMaps.forEach((n,i)=>{n.has(t)||e.push({type:"missing_auxiliary_entry",key:t,auxiliaryIndex:i,message:`Key ${t} in mainCache but missing in auxiliary map ${i}`})});for(const t of this.accessOrderMap.keys())this.mainCache.has(t)||e.push({type:"orphaned_access_order",key:t,message:`Key ${t} in access order but not in mainCache`});const t={mainCache:this.mainCache.size,accessOrder:this.accessOrderMap.size};return this.auxiliaryMaps.forEach((e,n)=>{t[`auxiliary_${n}`]=e.size}),{isValid:0===e.length,issues:e,sizes:t}}repairConsistency(){const e=[];for(const t of this.accessOrderMap.keys())this.mainCache.has(t)||(this.accessOrderMap.delete(t),e.push({action:"removed_orphaned_access_order",key:t}));this.auxiliaryMaps.forEach((t,n)=>{for(const i of t.keys())this.mainCache.has(i)||(t.delete(i),e.push({action:`removed_orphaned_auxiliary_${n}`,key:i}))});for(const t of this.mainCache.keys())this.auxiliaryMaps.forEach((n,i)=>{n.has(t)||(n.set(t,Date.now()),e.push({action:`added_missing_auxiliary_${i}`,key:t}))});const t={mainCache:this.mainCache.size,accessOrder:this.accessOrderMap.size};return this.auxiliaryMaps.forEach((e,n)=>{t[`auxiliary_${n}`]=e.size}),{actionsCount:e.length,actions:e,finalSizes:t}}getStats(){return{size:this.mainCache.size,maxSize:this.maxSize,accessOrderSize:this.accessOrderMap.size,auxiliarySizes:this.auxiliaryMaps.map(e=>e.size)}}}({maxSize:1e3,mainCache:D,accessOrderMap:x,auxiliaryMaps:[C],cacheName:"HiddenVideoCache"});function _(e){return e&&Number.isFinite(e.updatedAt)?e.updatedAt:-1}function V(e,t){if(e){if(t){const n=_(t);return D.set(e,t),C.set(e,-1===n?Date.now():n),R.updateAccessTime(e),void R.evictLRUEntries()}D.delete(e),C.set(e,Date.now()),x.delete(e)}}function k(e,t){if(!e)return;const n=_(t);if(C.has(e)){if(n<=C.get(e))return void R.updateAccessTime(e)}if(t)return D.set(e,t),C.set(e,-1===n?Date.now():n),R.updateAccessTime(e),void R.evictLRUEntries();D.delete(e),x.delete(e)}function Y(e){if(!e)return null;const t=D.get(e);return t&&R.updateAccessTime(e),t||null}function z(e){return D.has(e)}function B(){const{href:e}=window.location;return e.includes("/watch?")?"watch":e.match(/.*\/(user|channel|c)\/.+\/videos/u)||e.match(/.*\/@.*/u)?"channel":e.includes("/feed/subscriptions")?"subscriptions":e.includes("/feed/trending")?"trending":e.includes("/playlist?")?"playlist":"misc"}const W=new Map;function P(e,t,n,i=0){W.has(e)||W.set(e,{queries:0,successes:0,failures:0,lastSuccess:null,lastFailure:null,elementCounts:[]});const r=W.get(e);r.queries++,n&&i>0?(r.successes++,r.lastSuccess=Date.now(),r.elementCounts.push(i)):(r.failures++,r.lastFailure=Date.now()),r.elementCounts.length>100&&r.elementCounts.shift()}function $(e){const t=W.get(e);if(!t)return null;const n=t.queries>0?t.successes/t.queries:0,i=t.elementCounts.length>0?t.elementCounts.reduce((e,t)=>e+t,0)/t.elementCounts.length:0;return{...t,successRate:n,avgElementCount:i,isHealthy:n>.7&&t.queries>=10}}function q(){const e=["PROGRESS_BAR","VIDEO_CONTAINERS","THUMBNAILS","SHORTS_CONTAINERS"],t=[];for(const n of e){const e=$(n);e&&!e.isHealthy&&t.push({key:n,health:e})}return t}function U(){W.clear()}"undefined"!=typeof window&&(window.YTHWV_SelectorHealth={getStats:function(){const e={};for(const[t,n]of W.entries())e[t]=$(t);return e},getHealth:$,checkCritical:q,reset:U});const G=new WeakMap,j=new WeakMap,X=new WeakMap,K=new Map,F={hits:0,misses:0,invalidations:0};function Z(e,t){if(!e||!t)return null;try{G.has(e)||G.set(e,new Map);const n=G.get(e);if(n.has(t))return F.hits++,n.get(t);F.misses++;const i=e.closest(t);return n.set(t,i),i}catch(n){console.warn("[YT-HWV Cache] Error in cachedClosest:",n);try{return e.closest(t)}catch(e){return null}}}function Q(e,t){if(!e||!t)return null;try{j.has(e)||j.set(e,new Map);const n=j.get(e);if(n.has(t))return F.hits++,n.get(t);F.misses++;const i=e.querySelector(t);return n.set(t,i),i}catch(n){console.warn("[YT-HWV Cache] Error in cachedQuerySelector:",n);try{return e.querySelector(t)}catch(e){return null}}}function J(e,t=1e3){if(!e)return[];try{const n=Date.now();K.size>100&&function(){const e=Date.now(),t=[];for(const[n,i]of K.entries())e-i.timestamp>1e3&&t.push(n);t.forEach(e=>{K.delete(e)})}();const i=K.get(e);if(i&&n-i.timestamp<t)return F.hits++,i.results;F.misses++;const r=Array.from(document.querySelectorAll(e));return K.set(e,{results:r,timestamp:n}),r}catch(t){console.warn("[YT-HWV Cache] Error in cachedDocumentQuery:",t);try{return Array.from(document.querySelectorAll(e))}catch(e){return[]}}}function ee(e){if(!e)return K.clear(),void F.invalidations++;if("string"==typeof e)K.delete(e),F.invalidations++;else if(e instanceof RegExp){const t=[];for(const n of K.keys())e.test(n)&&t.push(n);t.forEach(e=>K.delete(e)),t.length>0&&F.invalidations++}}function te(){K.clear(),F.invalidations++}function ne(e,t,n=1e3){if(!t||0===t.length)return P(e,0,!1,0),[];for(let i=0;i<t.length;i++){const r=t[i];try{const t=J(r,n);if(t.length>0)return P(e,0,!0,t.length),t}catch(e){console.warn(`[YT-HWV] Selector failed: ${r}`,e)}}return P(e,t[0],!1,0),[]}function ie(e){if(!e)return null;const t=e.match(/\/watch\?v=([^&]+)/);if(t)return t[1];const n=e.match(/\/shorts\/([^?]+)/);return n?n[1]:null}function re(e){if(!e)return"";for(const t of v.TITLE_ELEMENTS){const n=Q(e,t);if(n&&!n.classList.contains(p)){const e=n.getAttribute("title")||n.getAttribute("aria-label")||n.textContent?.trim()||"";return e?e.includes(" - ")?e.split(" - ")[0]:e.includes(" by ")?e.split(" by ")[0]:e:""}}return""}function oe(){const e=ne("PROGRESS_BAR",S.PROGRESS_BAR,T),t=N.threshold,n=e.filter(e=>e.style.width&&parseInt(e.style.width,10)>=t);return H((e.length,n.length)),n}function ae(...e){e.forEach(e=>{!function(e){document.querySelectorAll(`.${e}`).forEach(t=>{t.classList.remove(e)})}(e)})}function se(){if(ae(l,d),window.location.href.indexOf("/feed/history")>=0)return;const e=B(),t=function(e){return N.watchedStates[e]}(e)||"normal";"normal"!==t&&oe().forEach(n=>{let i,r;if("subscriptions"===e)i=Z(n,".ytd-grid-renderer")||Z(n,".ytd-item-section-renderer")||Z(n,".ytd-rich-grid-row")||Z(n,".ytd-rich-grid-renderer")||Z(n,"#grid-container"),i?.classList.contains("ytd-item-section-renderer")&&Z(i,"ytd-item-section-renderer")?.classList.add(m);else if("playlist"===e)i=Z(n,"ytd-playlist-video-renderer");else if("watch"===e){i=Z(n,"ytd-compact-video-renderer"),Z(i,"ytd-compact-autoplay-renderer")&&(i=null);const e=Z(n,"ytd-playlist-panel-video-renderer");!i&&e&&(r=e)}else i=Z(n,"ytd-rich-item-renderer")||Z(n,"ytd-video-renderer")||Z(n,"ytd-grid-video-renderer")||Z(n,"ytm-video-with-context-renderer")||Z(n,"ytm-item-section-renderer");i&&("dimmed"===t?i.classList.add(l):"hidden"===t&&i.classList.add(d)),!r||"dimmed"!==t&&"hidden"!==t||r.classList.add(l)})}function ce(){ae(h,u);const e=function(e){return N.shortsStates[e]}(B())||"normal";if("normal"===e)return;(function(){const e=[],t=new Set;return v.SHORTS_CONTAINERS.forEach(n=>{try{J(n).forEach(n=>{const i=n.tagName+n.className;if(!t.has(i)){t.add(i);const r=Z(n,"ytd-reel-shelf-renderer")||Z(n,"ytd-rich-shelf-renderer")||Z(n,"ytd-rich-section-renderer");r&&!e.includes(r)?e.push(r):r||e.includes(n)||e.push(n)}})}catch(e){H()}}),J('a.reel-item-endpoint, a[href^="/shorts/"]').forEach(t=>{const n=Z(t,"ytd-rich-item-renderer")||Z(t,"ytd-video-renderer")||Z(t,"ytd-compact-video-renderer")||Z(t,"ytd-grid-video-renderer");n&&!e.includes(n)&&e.push(n)}),J('.ytd-thumbnail-overlay-time-status-renderer[aria-label="Shorts"]').forEach(t=>{const n=Z(t,"ytd-video-renderer")||Z(t,"ytd-compact-video-renderer")||Z(t,"ytd-grid-video-renderer");n&&!e.includes(n)&&e.push(n)}),J("ytd-rich-shelf-renderer").forEach(t=>{(Q(t,'a[href^="/shorts/"]')||Q(t,".reel-item-endpoint")||Q(t,".shortsLockupViewModelHost"))&&!e.includes(t)&&e.push(t)}),H(e.length),e})().forEach(t=>{"dimmed"===e?t.classList.add(h):"hidden"===e&&t.classList.add(u)})}const de={TRANSIENT:"transient",TIMEOUT:"timeout",QUOTA_EXCEEDED:"quota",PERMISSION:"permission",CORRUPTION:"corruption",NETWORK:"network",PERMANENT:"permanent"};function le(e){if(!e)return de.PERMANENT;const t=e.message?.toLowerCase()||"",n=e.name?.toLowerCase()||"";return!0===e.timeout||"timeouterror"===n||t.includes("timeout")&&t.includes("operation")?de.TIMEOUT:t.includes("quota")||n.includes("quotaexceedederror")?de.QUOTA_EXCEEDED:t.includes("transaction")||t.includes("aborted")||t.includes("busy")||n.includes("aborterror")?de.TRANSIENT:t.includes("extension context invalidated")||t.includes("context invalidated")?de.PERMANENT:t.includes("message")||t.includes("no response")||t.includes("no receiver")||t.includes("disconnected")||t.includes("timeout")||t.includes("could not establish connection")||t.includes("receiving end does not exist")?de.NETWORK:t.includes("permission")||n.includes("securityerror")?de.PERMISSION:t.includes("corrupt")||t.includes("invalid")||n.includes("dataerror")?de.CORRUPTION:de.PERMANENT}const ue=[];function he(e,t,n={}){const i={timestamp:Date.now(),context:e,type:le(t),message:t?.message||String(t),metadata:n};return ue.unshift(i),ue.length>100&&ue.pop(),console.error(`[${e}]`,t,n),i}let me=!1;function fe(){if(me)return!1;try{const e=chrome.runtime?.id;return!!e}catch(e){return me=!0,!1}}async function ye(e,t={}){return fe()?async function(e,t={}){const{maxAttempts:n=3,initialDelay:i=100,maxDelay:r=5e3,shouldRetry:o=e=>le(e)===de.TRANSIENT,onRetry:a=null}=t;let s,c=i;for(let t=1;t<=n;t++)try{return await e()}catch(e){if(s=e,t===n||!o(e))throw e;a&&a(t,e),await new Promise(e=>setTimeout(e,c)),c=Math.min(2*c,r)}throw s}(async()=>{try{const n=await function(e,t=5e3){return fe()?Promise.race([chrome.runtime.sendMessage(e),new Promise((e,n)=>setTimeout(()=>n(new Error("Message timeout")),t))]).catch(e=>{const t=e?.message?.toLowerCase()||"";throw(t.includes("extension context invalidated")||t.includes("context invalidated"))&&(me=!0),e}):Promise.reject(new Error("Extension context invalidated"))}({type:e,...t});if(!n)throw new Error("No response from background script");if(!n.ok){const e=new Error(n.error||"hidden video message failed");throw e.response=n,e}return n.result}catch(n){throw le(n)===de.PERMANENT&&n.message?.includes("context invalidated")||he("Messaging",n,{type:e,payload:t}),n}},{maxAttempts:5,initialDelay:300,maxDelay:3e3,shouldRetry:e=>{const t=le(e);return t===de.NETWORK||t===de.TRANSIENT}}):Promise.reject(new Error("Extension context invalidated"))}const pe="error",Ee="warning",ve="success",ge="info",we=new Map;function Te(e,t=ge,n=3e3){const i=function(){let e=document.getElementById("yt-hwv-notifications");e||(e=document.createElement("div"),e.id="yt-hwv-notifications",e.className="yt-hwv-notification-container",document.body.appendChild(e));return e}(),r=function(e,t){const n=document.createElement("div");n.className=`yt-hwv-notification ${t}`;const i=function(e){const t={error:"⚠",warning:"⚠",success:"✓",info:"ℹ"};return t[e]||t.info}(t),r=document.createElement("div");r.className="notification-icon",r.textContent=i;const o=document.createElement("div");o.className="notification-message",o.textContent=e;const a=document.createElement("button");return a.className="notification-close",a.setAttribute("aria-label","Close"),a.textContent="×",n.appendChild(r),n.appendChild(o),n.appendChild(a),a.addEventListener("click",()=>{be(null,n)}),n}(e,t);i.appendChild(r);const o=Date.now()+Math.random();return we.set(o,r),requestAnimationFrame(()=>{r.classList.add("visible")}),n>0&&setTimeout(()=>{be(o,r)},n),o}function be(e,t){t.classList.remove("visible"),setTimeout(()=>{t.remove(),e&&we.delete(e)},300)}async function Se(e){const t=Array.isArray(e)?e.filter(Boolean):[];if(0===t.length)return{};const n=Array.from(new Set(t)),i={},r=[],o=[];if(n.forEach(e=>{z(e)?i[e]=Y(e):!function(e){return M.has(e)}(e)?r.push(e):o.push(function(e){return M.get(e)}(e).then(t=>{i[e]=t}).catch(()=>{r.push(e)}))}),r.length>0){const e=ye(s,{ids:r}).then(e=>{const t=e.records||{};return r.forEach(e=>{k(e,t[e]||null),i[e]=Y(e)}),t}).catch(e=>{throw he("ContentMessaging",e,{operation:"fetchHiddenVideoStates",videoCount:r.length}),r.forEach(e=>{k(e,null),i[e]=null}),e}).finally(()=>{r.forEach(e=>function(e){M.delete(e)}(e))});r.forEach(t=>{const n=e.then(()=>Y(t)).catch(()=>null);!function(e,t){M.set(e,t)}(t,n),o.push(n.then(e=>{i[t]=e}))})}return o.length>0&&await Promise.allSettled(o),i}async function Ie(e,t,n){const i=e?String(e).trim():"";if(!i)return null;const r={videoId:i,state:t,title:n||"",updatedAt:Date.now()};V(i,"normal"===t?null:r);const o={videoId:i,state:t,title:n||""};try{const e=await ye(c,o);return e&&e.record?(V(i,e.record),e.record):(V(i,null),null)}catch(e){he("ContentMessaging",e,{operation:"setHiddenVideoState",videoId:i,state:t});const n=le(e);if("undefined"!=typeof document&&document.body){Te(n===de.NETWORK?"Unable to connect to extension. Please check your connection.":"Failed to save video state. Please try again.","error",3e3)}throw V(i,null),e}}const Ae=new Set,He=new Set;function Ne(e){return e.isIntersecting&&e.intersectionRatio>=b.VISIBILITY_THRESHOLD}function Le(e,t){He.forEach(n=>{try{n({becameVisible:e,becameHidden:t})}catch(e){H()}})}function Oe(){return new Set(Ae)}function De(e){if(!Array.isArray(e)||0===e.length)return;const t=[],n=[];e.forEach(e=>{const i=e.target,r=Ne(e);r&&function(e){return!Ae.has(e)&&(Ae.add(e),!0)}(i)?t.push(i):!r&&function(e){return Ae.delete(e)}(i)&&n.push(i)}),(t.length>0||n.length>0)&&(H((t.length,n.length)),Le(t,n))}let Ce=0,xe=!0;function Me(e,t){if(!e)return;const n=e.classList.contains(y),i=e.classList.contains(f);return"dimmed"===t?(i&&e.classList.remove(f),void(n||e.classList.add(y))):"hidden"===t?(n&&e.classList.remove(y),void(i||e.classList.add(f))):(n&&e.classList.remove(y),void(i&&e.classList.remove(f)))}async function Re(){if(!O())return void document.querySelectorAll(`.${y}, .${f}`).forEach(e=>{e.classList.remove(y,f)});H(),H(),H(b.ENABLE_LAZY_PROCESSING),H(Oe().size),Ce+=1;const e=Ce;let t;if(b.ENABLE_LAZY_PROCESSING&&!xe){const e=Oe(),n=new Set;e.forEach(e=>{if(e&&e.isConnected)try{const t=e.getAttribute("data-ythwv-video-id");t&&n.add(t);e.querySelectorAll('a[href*="/watch?v="], a[href*="/shorts/"]').forEach(e=>{const t=e.getAttribute("href");if(t){const e=ie(t);e&&n.add(e)}})}catch(e){H()}}),t=Array.from(n),H(t.length)}else t=function(){const e=new Set;return J("[data-ythwv-video-id]").forEach(t=>{const n=t.getAttribute("data-ythwv-video-id");n&&e.add(n)}),J('a[href*="/watch?v="], a[href*="/shorts/"]').forEach(t=>{const n=ie(t.getAttribute("href"));n&&e.add(n)}),Array.from(e)}(),H(t.length);if(0!==t.length){try{await Se(t)}catch(e){return void H()}e===Ce&&(t.forEach(e=>{if(!z(e))return;const t=Y(e),n=t?.state||"normal",i=function(e){const t=new Set;return J(`.${p}[data-video-id="${e}"]`).forEach(e=>{const n=Z(e,g.VIDEO_CONTAINERS);n&&t.add(n)}),J(`a[href*="/watch?v=${e}"], a[href*="/shorts/${e}"]`).forEach(e=>{const n=Z(e,g.VIDEO_CONTAINERS);n&&t.add(n)}),Array.from(t)}(e);i.forEach(e=>{var t;(!b.ENABLE_LAZY_PROCESSING||xe||(t=e,Ae.has(t)))&&Me(e,n)})}),xe&&(xe=!1,H()))}}function _e(e,t){e&&(e.classList.remove("dimmed","hidden"),"dimmed"===t?e.classList.add("dimmed"):"hidden"===t&&e.classList.add("hidden"))}function Ve(e,t){if(!t)return null;const n=document.createElement("button");n.className=p,n.setAttribute("data-video-id",t),n.setAttribute("tabindex","-1"),n.setAttribute("aria-label","Toggle video visibility");const i=Y(t);return _e(n,i?.state||"normal"),i||Se([t]).then(()=>{const e=Y(t),i=e?.state||"normal";_e(n,i);const r=Z(n,g.VIDEO_CONTAINERS);r&&Me(r,i)}).catch(e=>{he("EyeButton",e,{operation:"fetchHiddenVideoStates",videoId:t})}),n.innerHTML='\n    <svg viewBox="0 0 24 24">\n      <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>\n    </svg>\n  ',n.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const i=Y(t),r="normal"===(i?.state||"normal")?N.individualMode:"normal",o=Z(n,g.VIDEO_CONTAINERS);o&&o.setAttribute("data-ythwv-video-id",t);const a=re(o),s=await async function(e,t,n=null){return e?Ie(e,t,n||void 0):null}(t,r,a),c=s?s.state:"normal";_e(n,c),o&&(o.classList.remove(y,f),"dimmed"===c?o.classList.add(y):"hidden"===c&&o.classList.add(f));const d=new CustomEvent("yt-hwv-individual-update");document.dispatchEvent(d)}),n}function ke(){if(!O()){ne("EYE_BUTTON",[`.${p}`]).forEach(e=>e.remove());return void ne("HAS_EYE_BUTTON",[`.${E}`]).forEach(e=>e.classList.remove(E))}const e=ne("THUMBNAILS",S.THUMBNAILS);H(e.length),e.forEach(e=>{if(Q(e,`.${p}`))return;const t=Z(e,"a")||Q(e,"a");if(!t)return;const n=t.getAttribute("href");if(!n)return;let i=null;const r=n.match(/\/watch\?v=([^&]+)/),o=n.match(/\/shorts\/([^?]+)/);if(r?i=r[1]:o&&(i=o[1]),!i)return;const a=Ve(0,i);if(!a)return;e.style.position="relative",e.appendChild(a),e.classList.add(E),e.setAttribute("data-ythwv-video-id",i),ee(/yt-thumbnail.*not.*yt-hwv-has-eye-button/i);const s=Z(e,S.VIDEO_CONTAINERS.join(", "));s&&s.setAttribute("data-ythwv-video-id",i),Se([i]).then(()=>{const t=Y(i);if(t&&s&&Me(s,t.state),!t||t.title)return;const n=Z(e,S.VIDEO_CONTAINERS.join(", "));n&&n.setAttribute("data-ythwv-video-id",i);const r=re(n);r&&"Toggle video visibility"!==r&&async function(e,t,n=null){e&&Ie(e,t,n||void 0)}(i,t.state,r)}).catch(e=>{he("EyeButtonManager",e,{operation:"fetchHiddenVideoStates",videoId:i})}),H()}),document.querySelectorAll(`.${p}`).forEach(e=>{const t=e.closest('[aria-hidden="true"]');t&&t.removeAttribute("aria-hidden")})}function Ye(e){if(e&&e.type)return"updated"===e.type&&e.record?(V(e.record.videoId,e.record),document.querySelectorAll(`.${p}`).forEach(t=>{t.dataset.videoId===e.record.videoId&&_e(t,e.record.state)}),void Re()):"removed"===e.type&&e.videoId?(V(e.videoId,null),document.querySelectorAll(`.${p}`).forEach(t=>{t.dataset.videoId===e.videoId&&_e(t,"normal")}),void Re()):void("cleared"===e.type&&(R.clear(),document.querySelectorAll(`.${p}`).forEach(e=>{_e(e,"normal")}),Re()))}async function ze(){H(),se(),ce(),ke(),await Re()}let Be=null;function We(){var e;chrome.runtime.onMessage.addListener((e,t)=>((async()=>{"settingsUpdated"===e.action||"resetSettings"===e.action?(await L(),await ze()):"HIDDEN_VIDEOS_EVENT"===e.type&&Ye(e.event)})().catch(e=>{console.error("Error handling message in content script:",e)}),!1)),document.addEventListener("yt-hwv-individual-update",()=>{Re()}),b.ENABLE_LAZY_PROCESSING?(e=({becameVisible:e,becameHidden:t})=>{e.length>0&&(H(e.length),Re())},He.add(e),Be=()=>He.delete(e)):H()}function Pe(){Be&&(Be(),Be=null)}function $e(e,t){let n;const i=function(...i){clearTimeout(n),n=setTimeout(()=>e.apply(this,i),t)};return i.cancel=function(){clearTimeout(n),n=null},i}let qe=null,Ue=null,Ge=[];function je(e=null){if(!qe)return void H();const t=e||J(g.VIDEO_CONTAINERS);t.forEach(e=>{try{qe.observe(e)}catch(e){H()}}),H(t.length)}function Xe(){return b.ENABLE_LAZY_PROCESSING?(Ke(),qe=function(){const e={root:null,rootMargin:b.ROOT_MARGIN,threshold:b.THRESHOLD};Ue=$e(()=>{Ge.length>0&&(De([...Ge]),Ge.length=0)},b.BATCH_DELAY);const t=new IntersectionObserver(e=>{Ge.push(...e),Ue()},e);return H(),t}(),je(),qe):(H(),null)}function Ke(){qe&&(qe.disconnect(),qe=null,Ae.clear(),H()),Ge.length=0,Ue&&"function"==typeof Ue.cancel&&Ue.cancel(),Ue=null}function Fe(e){const t=$e(e,250),n=new MutationObserver(e=>{let n=!1,i=!1,r=!1;const o=[],a=[];var s;if(e.forEach(e=>{if("attributes"===e.type&&"aria-hidden"===e.attributeName){const t=e.target;"true"===t.getAttribute("aria-hidden")&&t.querySelector(`.${p}`)&&t.removeAttribute("aria-hidden")}else"childList"===e.type&&(n=!0,e.removedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){!function(e){if(!e)return;const t=G.get(e);t&&t.clear();const n=j.get(e);n&&n.clear();const i=X.get(e);i&&i.clear(),G.delete(e),j.delete(e),X.delete(e),F.invalidations++}(e);e.matches&&(e.matches("ytd-rich-item-renderer")||e.matches("ytd-video-renderer")||e.matches("ytd-grid-video-renderer")||e.matches("ytd-compact-video-renderer"))&&(i=!0,a.push(e))}}),e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){e.matches&&(e.matches("ytd-rich-item-renderer")||e.matches("ytd-video-renderer")||e.matches("ytd-grid-video-renderer")||e.matches("ytd-compact-video-renderer"))&&(i=!0,o.push(e));e.matches&&(e.matches("ytd-browse")||e.matches("ytd-watch-flexy")||e.matches("ytd-search"))&&(r=!0)}}))}),o.length>0&&je(o),a.length>0&&(s=a,qe&&s.forEach(e=>{try{qe.unobserve(e)}catch(e){H()}})),r?te():i&&[/ytd-rich-item-renderer/,/ytd-video-renderer/,/ytd-grid-video-renderer/,/ytd-compact-video-renderer/,/yt-thumbnail/,/progress.*bar/i,/watch\?v=/,/shorts\//].forEach(e=>{ee(e)}),n){if(1===e.length&&(e[0].target.classList?.contains(l)||e[0].target.classList?.contains(d)||e[0].target.classList?.contains(h)||e[0].target.classList?.contains(u)))return;t()}});return n.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-hidden"]}),n}function Ze(e){const t=$e(e,100);let n=location.href;const i=new MutationObserver(()=>{const e=location.href;e!==n&&(te(),Ke(),Xe(),n=e,setTimeout(t,100))});return i.observe(document,{subtree:!0,childList:!0}),i}const Qe=new Map;function Je(){setInterval(()=>{!function(){const e=q();e.length>0&&et(e)}()},I)}function et(e){for(const{key:t,health:n}of e){const e=Qe.get(t),i=Date.now();if(e&&i-e<A)continue;const r=tt(n.successRate);"critical"===r?(nt(t,n),Qe.set(t,i)):"warning"===r&&(it(t,n),Qe.set(t,i))}}function tt(e){return e<.3?"critical":e<.7?"warning":"ok"}function nt(e,t){console.error("[YT-HWV] Critical selector failure:","selector:",e,"successRate:",t.successRate,"queries:",t.queries),Te("YouTube structure changed. Some videos may not be detected. Please report this issue.",pe,8e3)}function it(e,t){console.warn("[YT-HWV] Selector degradation:","selector:",e,"successRate:",t.successRate),Te("Extension may not detect all videos. YouTube might have changed their layout.",Ee,5e3)}async function rt(){try{await async function(e=10,t=500){for(let n=1;n<=e;n++){try{const e=await ye(a,{});if(e&&e.ready)return!0;e&&e.error&&he("ContentInit",new Error("Background initialization error: "+e.error))}catch(t){he("ContentInit",t,{attempt:n,maxAttempts:e,message:"Health check failed, retrying..."})}n<e&&await new Promise(e=>setTimeout(e,t))}return!1}()||console.warn("[YT-HWV] Background script not ready, starting with limited functionality. Individual video hiding/dimming may not work until background service is ready.");try{e()}catch(e){throw he("ContentInit",e,{component:"styles",fatal:!0}),"undefined"!=typeof document&&document.body&&Te("YouTube Hide Watched Videos failed to load styles","error",5e3),e}await L(),U(),Je(),await ze(),Xe(),Fe(ze),function(e){const t=$e(e,100),n=XMLHttpRequest.prototype.open,i=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(e,t){return this._url=t,n.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){return this.addEventListener("readystatechange",function(){4===this.readyState&&this._url&&(this._url.includes("browse_ajax")||this._url.includes("browse?"))&&setTimeout(t,100)}),i.apply(this,arguments)}}(ze),Ze(ze),We()}catch(e){he("ContentInit",e,{fatal:!0}),"undefined"!=typeof document&&document.body&&Te("YouTube Hide Watched Videos extension failed to initialize","error",5e3)}}"undefined"!=typeof window&&(window.YTHWV_TestDOMHealth=function(){const e=q();return 0===e.length?(Te("All DOM selectors are healthy",ve,3e3),!0):(et(e),!1)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",rt):rt(),"undefined"!=typeof window&&(window.addEventListener("beforeunload",()=>{Ke(),Pe()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&Ke()}),window.addEventListener("pagehide",()=>{Ke(),Pe()})),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onSuspend?.addListener(()=>{Ke(),Pe()}),H()})();
//# sourceMappingURL=content.js.map