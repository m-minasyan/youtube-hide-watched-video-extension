(()=>{"use strict";function e(){const e="yt-hwv-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent="\n    .YT-HWV-WATCHED-HIDDEN { display: none !important }\n    .YT-HWV-WATCHED-DIMMED { opacity: 0.3 }\n    .YT-HWV-SHORTS-HIDDEN { display: none !important }\n    .YT-HWV-SHORTS-DIMMED { opacity: 0.3 }\n    .YT-HWV-HIDDEN-ROW-PARENT { padding-bottom: 10px }\n    .YT-HWV-INDIVIDUAL-HIDDEN { display: none !important }\n    .YT-HWV-INDIVIDUAL-DIMMED { opacity: 0.3 }\n\n    .yt-hwv-eye-button {\n      position: absolute !important;\n      top: 8px !important;\n      left: 50% !important;\n      transform: translateX(-50%) !important;\n      z-index: 999 !important;\n      background: rgba(0, 0, 0, 0.7) !important;\n      border: 1px solid rgba(255, 255, 255, 0.1) !important;\n      border-radius: 6px !important;\n      padding: 6px 8px !important;\n      cursor: pointer !important;\n      display: flex !important;\n      align-items: center !important;\n      justify-content: center !important;\n      transition: all 0.2s ease !important;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;\n      opacity: 0.3 !important;\n    }\n\n    .yt-hwv-eye-button:hover {\n      opacity: 1 !important;\n      background: rgba(0, 0, 0, 1) !important;\n      transform: translateX(-50%) scale(1.1) !important;\n      box-shadow: 0 4px 8px rgba(0,0,0,0.7) !important;\n    }\n\n    .yt-hwv-eye-button svg {\n      width: 20px !important;\n      height: 20px !important;\n      fill: white !important;\n      pointer-events: none !important;\n    }\n\n    .yt-hwv-eye-button.hidden svg {\n      fill: #ff4444 !important;\n    }\n\n    .yt-hwv-eye-button.dimmed svg {\n      fill: #ffaa00 !important;\n    }\n\n    ytd-thumbnail, yt-thumbnail-view-model, #dismissible, #thumbnail-container {\n      position: relative !important;\n    }\n  ",document.head.appendChild(t),function(){const e="yt-hwv-notification-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent='\n    .yt-hwv-notification-container {\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      z-index: 999999;\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n      max-width: 400px;\n    }\n\n    .yt-hwv-notification {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 12px 16px;\n      border-radius: 8px;\n      background: white;\n      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n      opacity: 0;\n      transform: translateX(100%);\n      transition: all 0.3s ease;\n    }\n\n    .yt-hwv-notification.visible {\n      opacity: 1;\n      transform: translateX(0);\n    }\n\n    .yt-hwv-notification.error {\n      background: #fee;\n      border-left: 4px solid #c00;\n      color: #c00;\n    }\n\n    .yt-hwv-notification.warning {\n      background: #ffc;\n      border-left: 4px solid #fa0;\n      color: #a60;\n    }\n\n    .yt-hwv-notification.success {\n      background: #efe;\n      border-left: 4px solid #0a0;\n      color: #060;\n    }\n\n    .yt-hwv-notification.info {\n      background: #eef;\n      border-left: 4px solid #06c;\n      color: #048;\n    }\n\n    .notification-icon {\n      font-size: 20px;\n      font-weight: bold;\n    }\n\n    .notification-message {\n      flex: 1;\n      font-size: 14px;\n    }\n\n    .notification-close {\n      background: none;\n      border: none;\n      font-size: 20px;\n      cursor: pointer;\n      opacity: 0.6;\n      padding: 0;\n      width: 20px;\n      height: 20px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .notification-close:hover {\n      opacity: 1;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification {\n      background: #333;\n      color: #fff;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.error {\n      background: #400;\n      border-left-color: #f88;\n      color: #fcc;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.warning {\n      background: #440;\n      border-left-color: #fa0;\n      color: #ffc;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.success {\n      background: #040;\n      border-left-color: #0f0;\n      color: #cfc;\n    }\n\n    [data-theme="dark"] .yt-hwv-notification.info {\n      background: #004;\n      border-left-color: #09f;\n      color: #ccf;\n    }\n  ',document.head.appendChild(t)}()}const t="YTHWV_THRESHOLD",n="YTHWV_STATE",i="YTHWV_STATE_SHORTS",s="YTHWV_INDIVIDUAL_MODE",r="YTHWV_INDIVIDUAL_MODE_ENABLED",o="HIDDEN_VIDEOS_HEALTH_CHECK",a="HIDDEN_VIDEOS_GET_MANY",c="HIDDEN_VIDEOS_SET_STATE",d="YT-HWV-WATCHED-HIDDEN",l="YT-HWV-WATCHED-DIMMED",h="YT-HWV-SHORTS-HIDDEN",u="YT-HWV-SHORTS-DIMMED",m="YT-HWV-HIDDEN-ROW-PARENT",f="YT-HWV-INDIVIDUAL-HIDDEN",p="YT-HWV-INDIVIDUAL-DIMMED",y="yt-hwv-eye-button",v="yt-hwv-has-eye-button",g={PROGRESS_BAR:[".ytd-thumbnail-overlay-resume-playback-renderer",".ytThumbnailOverlayProgressBarHostWatchedProgressBarSegment",".ytp-progress-bar-played"],SHORTS_CONTAINERS:["ytd-reel-shelf-renderer","ytd-rich-shelf-renderer[is-shorts]","ytd-rich-section-renderer:has(ytd-rich-shelf-renderer[is-shorts])","ytm-shorts-lockup-view-model-v2","ytm-shorts-lockup-view-model","ytd-rich-item-renderer:has(.shortsLockupViewModelHost)",'ytd-rich-item-renderer:has(a[href^="/shorts/"])',".ytd-rich-shelf-renderer:has(a.reel-item-endpoint)",'ytd-video-renderer:has(.ytd-thumbnail-overlay-time-status-renderer[aria-label="Shorts"])','ytd-compact-video-renderer:has(a[href^="/shorts/"])','ytd-grid-video-renderer:has(a[href^="/shorts/"])'],THUMBNAILS:["yt-thumbnail-view-model:not(.yt-hwv-has-eye-button)","ytd-thumbnail:not(.yt-hwv-has-eye-button)"],VIDEO_CONTAINERS:["ytd-rich-item-renderer","ytd-video-renderer","ytd-grid-video-renderer","ytd-compact-video-renderer","yt-lockup-view-model","ytm-shorts-lockup-view-model"],TITLE_ELEMENTS:["#video-title","#video-title-link","a#video-title","h3.title","h3 a","h4 a",".title-and-badge a","ytm-shorts-lockup-view-model-v2 .shortsLockupViewModelHostTextContent","yt-formatted-string#video-title","span#video-title"]},E={VIDEO_CONTAINERS:g.VIDEO_CONTAINERS.join(", "),THUMBNAILS:g.THUMBNAILS.join(", "),SHORTS_CONTAINERS:g.SHORTS_CONTAINERS.join(", ")},T=!1,w=500,S=function(){const e={ROOT_MARGIN:"100px",THRESHOLD:[0,.25,.5],VISIBILITY_THRESHOLD:.25,BATCH_DELAY:100,ENABLE_LAZY_PROCESSING:!0};return Array.isArray(e.THRESHOLD)&&0!==e.THRESHOLD.length||(console.error("[YT-HWV] Invalid THRESHOLD config, using defaults"),e.THRESHOLD=[0,.25,.5]),e.THRESHOLD=e.THRESHOLD.filter(e=>"number"==typeof e&&e>=0&&e<=1),("number"!=typeof e.VISIBILITY_THRESHOLD||e.VISIBILITY_THRESHOLD<0||e.VISIBILITY_THRESHOLD>1)&&(console.error("[YT-HWV] Invalid VISIBILITY_THRESHOLD config, using default 0.25"),e.VISIBILITY_THRESHOLD=.25),("number"!=typeof e.BATCH_DELAY||e.BATCH_DELAY<0)&&(console.error("[YT-HWV] Invalid BATCH_DELAY config, using default 100ms"),e.BATCH_DELAY=100),e}(),b={VIDEO_TITLE:["#video-title","#video-title-link","a#video-title","h3.title a","h3 a","h4 a",".title-and-badge a","yt-formatted-string#video-title","span#video-title",'a[href*="/watch?v="]','a[href*="/shorts/"]'],PROGRESS_BAR:[".ytd-thumbnail-overlay-resume-playback-renderer",".yt-thumbnail-overlay-resume-playback-renderer-wiz__progress-bar",".ytThumbnailOverlayProgressBarHostWatchedProgressBarSegment",".ytp-progress-bar-played","yt-thumbnail-overlay-resume-playback-renderer",".ytm-thumbnail-overlay-resume-playback-renderer",'[class*="progress"][class*="bar"]','[class*="watched"]'],VIDEO_THUMBNAIL:["yt-thumbnail-view-model","ytd-thumbnail",".ytThumbnailViewModelImage","img.yt-core-image",'[class*="thumbnail"]'],VIDEO_LINK:['a[href*="/watch?v="]','a[href^="/watch?"]','a[href*="&v="]',"a.ytd-thumbnail","a.yt-simple-endpoint"],SHORTS_LINK:['a[href*="/shorts/"]','a[href^="/shorts/"]',"a.reel-item-endpoint",".shortsLockupViewModelHost a"],VIDEO_CONTAINERS:["ytd-rich-item-renderer","ytd-video-renderer","ytd-grid-video-renderer","ytd-compact-video-renderer","yt-lockup-view-model","ytm-shorts-lockup-view-model"],THUMBNAILS:["yt-thumbnail-view-model:not(.yt-hwv-has-eye-button)","ytd-thumbnail:not(.yt-hwv-has-eye-button)"]},I=3e4,A=3e5;function R(...e){T}let O={threshold:10,watchedStates:{},shortsStates:{},individualMode:"dimmed",individualModeEnabled:!0};async function H(){const e=await chrome.storage.sync.get(null);O.threshold=e[t]||10,O.individualMode=e[s]||"dimmed",O.individualModeEnabled=void 0===e[r]||e[r];["misc","subscriptions","channel","watch","trending","playlist"].forEach(t=>{O.watchedStates[t]=e[`${n}_${t}`]||"normal","playlist"!==t&&(O.shortsStates[t]=e[`${i}_${t}`]||"normal")}),R()}function L(){return O.individualModeEnabled}const N=new class{constructor(e={}){this.maxSize=e.maxSize||1e3,this.cacheTTL=e.cacheTTL||null,this.separateTimestamps=e.separateTimestamps||!1,this.trackPendingRequests=e.trackPendingRequests||!1,this.cache=new Map,this.cacheAccessOrder=new Map,this.timestamps=this.separateTimestamps?new Map:null,this.pendingRequests=this.trackPendingRequests?new Map:null,this.isEvicting=!1}evictLRUEntries(){if(!(this.cache.size<=this.maxSize||this.isEvicting))try{if(this.isEvicting=!0,this.cache.size<=this.maxSize)return;const e=Array.from(this.cacheAccessOrder.entries()).sort((e,t)=>e[1]-t[1]),t=this.cache.size-this.maxSize,n=e.slice(0,t);n.map(([e])=>e).forEach(e=>{this.cache.delete(e),this.cacheAccessOrder.delete(e),this.timestamps&&this.timestamps.delete(e)}),this._validateSizeConsistency()}finally{this.isEvicting=!1}}_validateSizeConsistency(){this.separateTimestamps&&this.cache.size!==this.timestamps.size&&console.error("[UnifiedCacheManager] Inconsistency detected: cache size",this.cache.size,"vs timestamps size",this.timestamps.size)}_getRecordTimestamp(e){return e?Number.isFinite(e.updatedAt)?e.updatedAt:Number.isFinite(e.timestamp)?e.timestamp:-1:-1}get(e){if(!e)return null;const t=this.cache.get(e);if(!t)return;let n,i;return this.separateTimestamps?(n=t,i=this.timestamps.get(e)):(n=t.record,i=t.timestamp),null!==this.cacheTTL&&i&&Date.now()-i>this.cacheTTL?(this.cache.delete(e),this.cacheAccessOrder.delete(e),void(this.timestamps&&this.timestamps.delete(e))):(this.cacheAccessOrder.set(e,Date.now()),n)}set(e,t){if(!e)return;const n=Date.now(),i=this._getRecordTimestamp(t);this.separateTimestamps?(this.cache.set(e,t),this.timestamps.set(e,-1===i?n:i)):this.cache.set(e,{record:t,timestamp:n}),this.cacheAccessOrder.set(e,n),this.evictLRUEntries()}applyUpdate(e,t){e&&(t?this.set(e,t):this.separateTimestamps?(this.cache.delete(e),this.timestamps.set(e,Date.now()),this.cacheAccessOrder.delete(e)):(this.cache.delete(e),this.cacheAccessOrder.delete(e)))}mergeFetchedRecord(e,t){if(!e)return;const n=this._getRecordTimestamp(t);if(this.separateTimestamps&&this.timestamps.has(e)){if(n<=this.timestamps.get(e))return void this.cacheAccessOrder.set(e,Date.now())}t?this.set(e,t):(this.cache.delete(e),this.cacheAccessOrder.delete(e),this.timestamps&&this.timestamps.delete(e))}invalidate(e){e&&(this.cache.delete(e),this.cacheAccessOrder.delete(e),this.timestamps&&this.timestamps.delete(e))}has(e){return this.cache.has(e)}clear(){this.isEvicting=!1,this.cache.clear(),this.cacheAccessOrder.clear(),this.timestamps&&this.timestamps.clear(),this.pendingRequests&&this.pendingRequests.clear()}getStats(){const e={size:this.cache.size,maxSize:this.maxSize,mode:this.separateTimestamps?"3-Map":"2-Map",accessOrderSize:this.cacheAccessOrder.size};return null!==this.cacheTTL&&(e.ttl=this.cacheTTL),this.timestamps&&(e.timestampsSize=this.timestamps.size),this.pendingRequests&&(e.pendingRequestsSize=this.pendingRequests.size),e}getMemoryUsage(){let e=0;return this.cache.forEach((t,n)=>{e+=2*n.length;const i=this.separateTimestamps?t:t.record;i&&(e+=2*(i.title?.length||0),e+=32)}),e}validateConsistency(){const e=[];if(this.separateTimestamps&&this.cache.size!==this.timestamps.size&&e.push({type:"size_mismatch",message:`cache size (${this.cache.size}) !== timestamps size (${this.timestamps.size})`}),this.separateTimestamps)for(const t of this.cache.keys())this.timestamps.has(t)||e.push({type:"missing_timestamp",videoId:t,message:`Video ${t} in cache but missing timestamp`});for(const t of this.cacheAccessOrder.keys())this.cache.has(t)||this.separateTimestamps&&this.timestamps.has(t)||e.push({type:"orphaned_access_order",videoId:t,message:`Video ${t} in access order but not in cache`});if(this.separateTimestamps)for(const e of this.timestamps.keys())!this.cache.has(e)&&this.cacheAccessOrder.has(e);const t={cache:this.cache.size,accessOrder:this.cacheAccessOrder.size};return this.timestamps&&(t.timestamps=this.timestamps.size),{isValid:0===e.length,issues:e,sizes:t}}repairConsistency(){const e=[];for(const t of this.cacheAccessOrder.keys())if(!this.cache.has(t)){if(this.separateTimestamps&&this.timestamps.has(t))continue;this.cacheAccessOrder.delete(t),e.push({action:"removed_orphaned_access_order",videoId:t})}if(this.separateTimestamps){for(const t of this.timestamps.keys())this.cache.has(t)||this.cacheAccessOrder.has(t)||(this.timestamps.delete(t),e.push({action:"removed_orphaned_timestamp",videoId:t}));for(const t of this.cache.keys())this.timestamps.has(t)||(this.timestamps.set(t,Date.now()),e.push({action:"added_missing_timestamp",videoId:t}))}for(const t of this.cache.keys())this.cacheAccessOrder.has(t)||(this.cacheAccessOrder.set(t,Date.now()),e.push({action:"added_missing_access_order",videoId:t}));const t={cache:this.cache.size,accessOrder:this.cacheAccessOrder.size};return this.timestamps&&(t.timestamps=this.timestamps.size),{actionsCount:e.length,actions:e,finalSizes:t}}hasPendingRequest(e){return!!this.pendingRequests&&this.pendingRequests.has(e)}getPendingRequest(e){return this.pendingRequests?this.pendingRequests.get(e):void 0}setPendingRequest(e,t){this.pendingRequests&&this.pendingRequests.set(e,t)}deletePendingRequest(e){this.pendingRequests&&this.pendingRequests.delete(e)}clearPendingRequests(){this.pendingRequests&&this.pendingRequests.clear()}}({maxSize:1e3,cacheTTL:null,separateTimestamps:!0,trackPendingRequests:!0});function D(e,t){N.applyUpdate(e,t)}function _(e,t){N.mergeFetchedRecord(e,t)}function x(e){return N.get(e)||null}function C(e){return N.has(e)}function M(){const{href:e}=window.location;return e.includes("/watch?")?"watch":e.match(/.*\/(user|channel|c)\/.+\/videos/u)||e.match(/.*\/@.*/u)?"channel":e.includes("/feed/subscriptions")?"subscriptions":e.includes("/feed/trending")?"trending":e.includes("/playlist?")?"playlist":"misc"}const V=new Map;function k(e,t,n,i=0){V.has(e)||V.set(e,{queries:0,successes:0,failures:0,lastSuccess:null,lastFailure:null,elementCounts:[]});const s=V.get(e);s.queries++,n&&i>0?(s.successes++,s.lastSuccess=Date.now(),s.elementCounts.push(i)):(s.failures++,s.lastFailure=Date.now()),s.elementCounts.length>100&&s.elementCounts.shift()}function Y(e){const t=V.get(e);if(!t)return null;const n=t.queries>0?t.successes/t.queries:0,i=t.elementCounts.length>0?t.elementCounts.reduce((e,t)=>e+t,0)/t.elementCounts.length:0;return{...t,successRate:n,avgElementCount:i,isHealthy:n>.7&&t.queries>=10}}function q(){const e=["PROGRESS_BAR","VIDEO_CONTAINERS","THUMBNAILS","SHORTS_CONTAINERS"],t=[];for(const n of e){const e=Y(n);e&&!e.isHealthy&&t.push({key:n,health:e})}return t}function z(){V.clear()}"undefined"!=typeof window&&(window.YTHWV_SelectorHealth={getStats:function(){const e={};for(const[t,n]of V.entries())e[t]=Y(t);return e},getHealth:Y,checkCritical:q,reset:z});const P=new WeakMap,B=new WeakMap,W=new WeakMap,U=new Map,$={hits:0,misses:0,invalidations:0};function G(e,t){if(!e||!t)return null;try{P.has(e)||P.set(e,new Map);const n=P.get(e);if(n.has(t))return $.hits++,n.get(t);$.misses++;const i=e.closest(t);return n.set(t,i),i}catch(n){console.warn("[YT-HWV Cache] Error in cachedClosest:",n);try{return e.closest(t)}catch(e){return null}}}function j(e,t){if(!e||!t)return null;try{B.has(e)||B.set(e,new Map);const n=B.get(e);if(n.has(t))return $.hits++,n.get(t);$.misses++;const i=e.querySelector(t);return n.set(t,i),i}catch(n){console.warn("[YT-HWV Cache] Error in cachedQuerySelector:",n);try{return e.querySelector(t)}catch(e){return null}}}function X(e,t=1e3){if(!e)return[];try{const n=Date.now();U.size>100&&function(){const e=Date.now(),t=[];for(const[n,i]of U.entries())e-i.timestamp>1e3&&t.push(n);t.forEach(e=>{U.delete(e)})}();const i=U.get(e);if(i&&n-i.timestamp<t)return $.hits++,i.results;$.misses++;const s=Array.from(document.querySelectorAll(e));return U.set(e,{results:s,timestamp:n}),s}catch(t){console.warn("[YT-HWV Cache] Error in cachedDocumentQuery:",t);try{return Array.from(document.querySelectorAll(e))}catch(e){return[]}}}function F(e){if(!e)return U.clear(),void $.invalidations++;if("string"==typeof e)U.delete(e),$.invalidations++;else if(e instanceof RegExp){const t=[];for(const n of U.keys())e.test(n)&&t.push(n);t.forEach(e=>U.delete(e)),t.length>0&&$.invalidations++}}function K(){U.clear(),$.invalidations++}function Z(e,t,n=1e3){if(!t||0===t.length)return k(e,0,!1,0),[];for(let i=0;i<t.length;i++){const s=t[i];try{const t=X(s,n);if(t.length>0)return k(e,0,!0,t.length),t}catch(e){console.warn(`[YT-HWV] Selector failed: ${s}`,e)}}return k(e,t[0],!1,0),[]}function Q(e){if(!e)return null;const t=e.match(/\/watch\?v=([^&]+)/);if(t)return t[1];const n=e.match(/\/shorts\/([^?]+)/);return n?n[1]:null}function J(e){if(!e)return"";for(const t of g.TITLE_ELEMENTS){const n=j(e,t);if(n&&!n.classList.contains(y)){const e=n.getAttribute("title")||n.getAttribute("aria-label")||n.textContent?.trim()||"";return e?e.includes(" - ")?e.split(" - ")[0]:e.includes(" by ")?e.split(" by ")[0]:e:""}}return""}function ee(){const e=Z("PROGRESS_BAR",b.PROGRESS_BAR,w),t=O.threshold,n=e.filter(e=>e.style.width&&parseInt(e.style.width,10)>=t);return R((e.length,n.length)),n}function te(...e){e.forEach(e=>{!function(e){document.querySelectorAll(`.${e}`).forEach(t=>{t.classList.remove(e)})}(e)})}function ne(){if(te(l,d),window.location.href.indexOf("/feed/history")>=0)return;const e=M(),t=function(e){return O.watchedStates[e]}(e)||"normal";"normal"!==t&&ee().forEach(n=>{let i,s;if("subscriptions"===e)i=G(n,".ytd-grid-renderer")||G(n,".ytd-item-section-renderer")||G(n,".ytd-rich-grid-row")||G(n,".ytd-rich-grid-renderer")||G(n,"#grid-container"),i?.classList.contains("ytd-item-section-renderer")&&G(i,"ytd-item-section-renderer")?.classList.add(m);else if("playlist"===e)i=G(n,"ytd-playlist-video-renderer");else if("watch"===e){i=G(n,"ytd-compact-video-renderer"),G(i,"ytd-compact-autoplay-renderer")&&(i=null);const e=G(n,"ytd-playlist-panel-video-renderer");!i&&e&&(s=e)}else i=G(n,"ytd-rich-item-renderer")||G(n,"ytd-video-renderer")||G(n,"ytd-grid-video-renderer")||G(n,"ytm-video-with-context-renderer")||G(n,"ytm-item-section-renderer");i&&("dimmed"===t?i.classList.add(l):"hidden"===t&&i.classList.add(d)),!s||"dimmed"!==t&&"hidden"!==t||s.classList.add(l)})}function ie(){te(u,h);const e=function(e){return O.shortsStates[e]}(M())||"normal";if("normal"===e)return;(function(){const e=[],t=new Set;return g.SHORTS_CONTAINERS.forEach(n=>{try{X(n).forEach(n=>{const i=n.tagName+n.className;if(!t.has(i)){t.add(i);const s=G(n,"ytd-reel-shelf-renderer")||G(n,"ytd-rich-shelf-renderer")||G(n,"ytd-rich-section-renderer");s&&!e.includes(s)?e.push(s):s||e.includes(n)||e.push(n)}})}catch(e){R()}}),X('a.reel-item-endpoint, a[href^="/shorts/"]').forEach(t=>{const n=G(t,"ytd-rich-item-renderer")||G(t,"ytd-video-renderer")||G(t,"ytd-compact-video-renderer")||G(t,"ytd-grid-video-renderer");n&&!e.includes(n)&&e.push(n)}),X('.ytd-thumbnail-overlay-time-status-renderer[aria-label="Shorts"]').forEach(t=>{const n=G(t,"ytd-video-renderer")||G(t,"ytd-compact-video-renderer")||G(t,"ytd-grid-video-renderer");n&&!e.includes(n)&&e.push(n)}),X("ytd-rich-shelf-renderer").forEach(t=>{(j(t,'a[href^="/shorts/"]')||j(t,".reel-item-endpoint")||j(t,".shortsLockupViewModelHost"))&&!e.includes(t)&&e.push(t)}),R(e.length),e})().forEach(t=>{"dimmed"===e?t.classList.add(u):"hidden"===e&&t.classList.add(h)})}const se={TRANSIENT:"transient",TIMEOUT:"timeout",QUOTA_EXCEEDED:"quota",PERMISSION:"permission",CORRUPTION:"corruption",NETWORK:"network",PERMANENT:"permanent"};function re(e){if(!e)return se.PERMANENT;const t=e.message?.toLowerCase()||"",n=e.name?.toLowerCase()||"";return!0===e.timeout||"timeouterror"===n||t.includes("timeout")&&t.includes("operation")?se.TIMEOUT:t.includes("quota")||n.includes("quotaexceedederror")?se.QUOTA_EXCEEDED:t.includes("transaction")||t.includes("aborted")||t.includes("busy")||n.includes("aborterror")?se.TRANSIENT:t.includes("extension context invalidated")||t.includes("context invalidated")?se.PERMANENT:t.includes("message")||t.includes("no response")||t.includes("no receiver")||t.includes("disconnected")||t.includes("timeout")||t.includes("could not establish connection")||t.includes("receiving end does not exist")?se.NETWORK:t.includes("permission")||n.includes("securityerror")?se.PERMISSION:t.includes("corrupt")||t.includes("invalid")||n.includes("dataerror")?se.CORRUPTION:se.PERMANENT}const oe=[];function ae(e,t,n={}){const i={timestamp:Date.now(),context:e,type:re(t),message:t?.message||String(t),metadata:n};return oe.unshift(i),oe.length>100&&oe.pop(),console.error(`[${e}]`,t,n),i}let ce=!1;function de(){if(ce)return!1;try{const e=chrome.runtime?.id;return!!e}catch(e){return ce=!0,!1}}async function le(e,t={}){return de()?async function(e,t={}){const{maxAttempts:n=3,initialDelay:i=100,maxDelay:s=5e3,shouldRetry:r=e=>re(e)===se.TRANSIENT,onRetry:o=null}=t;let a,c=i;for(let t=1;t<=n;t++)try{return await e()}catch(e){if(a=e,t===n||!r(e))throw e;o&&o(t,e),await new Promise(e=>setTimeout(e,c)),c=Math.min(2*c,s)}throw a}(async()=>{try{const n=await function(e,t=5e3){return de()?Promise.race([chrome.runtime.sendMessage(e),new Promise((e,n)=>setTimeout(()=>n(new Error("Message timeout")),t))]).catch(e=>{const t=e?.message?.toLowerCase()||"";throw(t.includes("extension context invalidated")||t.includes("context invalidated"))&&(ce=!0),e}):Promise.reject(new Error("Extension context invalidated"))}({type:e,...t});if(!n)throw new Error("No response from background script");if(!n.ok){const e=new Error(n.error||"hidden video message failed");throw e.response=n,e}return n.result}catch(n){throw re(n)===se.PERMANENT&&n.message?.includes("context invalidated")||ae("Messaging",n,{type:e,payload:t}),n}},{maxAttempts:5,initialDelay:300,maxDelay:3e3,shouldRetry:e=>{const t=re(e);return t===se.NETWORK||t===se.TRANSIENT}}):Promise.reject(new Error("Extension context invalidated"))}const he="error",ue="warning",me="success",fe="info",pe=new Map;function ye(e,t=fe,n=3e3){const i=function(){let e=document.getElementById("yt-hwv-notifications");e||(e=document.createElement("div"),e.id="yt-hwv-notifications",e.className="yt-hwv-notification-container",document.body.appendChild(e));return e}(),s=function(e,t){const n=document.createElement("div");n.className=`yt-hwv-notification ${t}`;const i=function(e){const t={error:"⚠",warning:"⚠",success:"✓",info:"ℹ"};return t[e]||t.info}(t),s=document.createElement("div");s.className="notification-icon",s.textContent=i;const r=document.createElement("div");r.className="notification-message",r.textContent=e;const o=document.createElement("button");return o.className="notification-close",o.setAttribute("aria-label","Close"),o.textContent="×",n.appendChild(s),n.appendChild(r),n.appendChild(o),o.addEventListener("click",()=>{ve(null,n)}),n}(e,t);i.appendChild(s);const r=Date.now()+Math.random();return pe.set(r,s),requestAnimationFrame(()=>{s.classList.add("visible")}),n>0&&setTimeout(()=>{ve(r,s)},n),r}function ve(e,t){t.classList.remove("visible"),setTimeout(()=>{t.remove(),e&&pe.delete(e)},300)}async function ge(e){const t=Array.isArray(e)?e.filter(Boolean):[];if(0===t.length)return{};const n=Array.from(new Set(t)),i={},s=[],r=[];if(n.forEach(e=>{C(e)?i[e]=x(e):!function(e){return N.hasPendingRequest(e)}(e)?s.push(e):r.push(function(e){return N.getPendingRequest(e)}(e).then(t=>{i[e]=t}).catch(()=>{s.push(e)}))}),s.length>0){const e=le(a,{ids:s}).then(e=>{const t=e.records||{};return s.forEach(e=>{_(e,t[e]||null),i[e]=x(e)}),t}).catch(e=>{throw ae("ContentMessaging",e,{operation:"fetchHiddenVideoStates",videoCount:s.length}),s.forEach(e=>{_(e,null),i[e]=null}),e}).finally(()=>{s.forEach(e=>function(e){N.deletePendingRequest(e)}(e))});s.forEach(t=>{const n=e.then(()=>x(t)).catch(()=>null);!function(e,t){N.setPendingRequest(e,t)}(t,n),r.push(n.then(e=>{i[t]=e}))})}return r.length>0&&await Promise.allSettled(r),i}async function Ee(e,t,n){const i=e?String(e).trim():"";if(!i)return null;const s={videoId:i,state:t,title:n||"",updatedAt:Date.now()};D(i,"normal"===t?null:s);const r={videoId:i,state:t,title:n||""};try{const e=await le(c,r);return e&&e.record?(D(i,e.record),e.record):(D(i,null),null)}catch(e){ae("ContentMessaging",e,{operation:"setHiddenVideoState",videoId:i,state:t});const n=re(e);if("undefined"!=typeof document&&document.body){ye(n===se.NETWORK?"Unable to connect to extension. Please check your connection.":"Failed to save video state. Please try again.","error",3e3)}throw D(i,null),e}}const Te=new Set,we=new Set;function Se(e){return e.isIntersecting&&e.intersectionRatio>=S.VISIBILITY_THRESHOLD}function be(e,t){we.forEach(n=>{try{n({becameVisible:e,becameHidden:t})}catch(e){R()}})}function Ie(){return new Set(Te)}function Ae(e){if(!Array.isArray(e)||0===e.length)return;const t=[],n=[];e.forEach(e=>{const i=e.target,s=Se(e);s&&function(e){return!Te.has(e)&&(Te.add(e),!0)}(i)?t.push(i):!s&&function(e){return Te.delete(e)}(i)&&n.push(i)}),(t.length>0||n.length>0)&&(R((t.length,n.length)),be(t,n))}let Re=0,Oe=!0;function He(e,t){if(!e)return;const n=e.classList.contains(p),i=e.classList.contains(f);return"dimmed"===t?(i&&e.classList.remove(f),void(n||e.classList.add(p))):"hidden"===t?(n&&e.classList.remove(p),void(i||e.classList.add(f))):(n&&e.classList.remove(p),void(i&&e.classList.remove(f)))}async function Le(){if(!L())return void document.querySelectorAll(`.${p}, .${f}`).forEach(e=>{e.classList.remove(p,f)});R(),R(),R(S.ENABLE_LAZY_PROCESSING),R(Ie().size),Re+=1;const e=Re;let t;if(S.ENABLE_LAZY_PROCESSING&&!Oe){const e=Ie(),n=new Set;e.forEach(e=>{if(e&&e.isConnected)try{const t=e.getAttribute("data-ythwv-video-id");t&&n.add(t);e.querySelectorAll('a[href*="/watch?v="], a[href*="/shorts/"]').forEach(e=>{const t=e.getAttribute("href");if(t){const e=Q(t);e&&n.add(e)}})}catch(e){R()}}),t=Array.from(n),R(t.length)}else t=function(){const e=new Set;return X("[data-ythwv-video-id]").forEach(t=>{const n=t.getAttribute("data-ythwv-video-id");n&&e.add(n)}),X('a[href*="/watch?v="], a[href*="/shorts/"]').forEach(t=>{const n=Q(t.getAttribute("href"));n&&e.add(n)}),Array.from(e)}(),R(t.length);if(0!==t.length){try{await ge(t)}catch(e){return void R()}e===Re&&(t.forEach(e=>{if(!C(e))return;const t=x(e),n=t?.state||"normal",i=function(e){const t=new Set;return X(`.${y}[data-video-id="${e}"]`).forEach(e=>{const n=G(e,E.VIDEO_CONTAINERS);n&&t.add(n)}),X(`a[href*="/watch?v=${e}"], a[href*="/shorts/${e}"]`).forEach(e=>{const n=G(e,E.VIDEO_CONTAINERS);n&&t.add(n)}),Array.from(t)}(e);i.forEach(e=>{var t;(!S.ENABLE_LAZY_PROCESSING||Oe||(t=e,Te.has(t)))&&He(e,n)})}),Oe&&(Oe=!1,R()))}}function Ne(e,t){e&&(e.classList.remove("dimmed","hidden"),"dimmed"===t?e.classList.add("dimmed"):"hidden"===t&&e.classList.add("hidden"))}function De(e,t){if(!t)return null;const n=document.createElement("button");n.className=y,n.setAttribute("data-video-id",t),n.setAttribute("tabindex","-1"),n.setAttribute("aria-label","Toggle video visibility");const i=x(t);return Ne(n,i?.state||"normal"),i||ge([t]).then(()=>{const e=x(t),i=e?.state||"normal";Ne(n,i);const s=G(n,E.VIDEO_CONTAINERS);s&&He(s,i)}).catch(e=>{ae("EyeButton",e,{operation:"fetchHiddenVideoStates",videoId:t})}),n.innerHTML='\n    <svg viewBox="0 0 24 24">\n      <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>\n    </svg>\n  ',n.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const i=x(t),s="normal"===(i?.state||"normal")?O.individualMode:"normal",r=G(n,E.VIDEO_CONTAINERS);r&&r.setAttribute("data-ythwv-video-id",t);const o=J(r),a=await async function(e,t,n=null){return e?Ee(e,t,n||void 0):null}(t,s,o),c=a?a.state:"normal";Ne(n,c),r&&(r.classList.remove(p,f),"dimmed"===c?r.classList.add(p):"hidden"===c&&r.classList.add(f));const d=new CustomEvent("yt-hwv-individual-update");document.dispatchEvent(d)}),n}function _e(){if(!L()){Z("EYE_BUTTON",[`.${y}`]).forEach(e=>e.remove());return void Z("HAS_EYE_BUTTON",[`.${v}`]).forEach(e=>e.classList.remove(v))}const e=Z("THUMBNAILS",b.THUMBNAILS);R(e.length),e.forEach(e=>{if(j(e,`.${y}`))return;const t=G(e,"a")||j(e,"a");if(!t)return;const n=t.getAttribute("href");if(!n)return;let i=null;const s=n.match(/\/watch\?v=([^&]+)/),r=n.match(/\/shorts\/([^?]+)/);if(s?i=s[1]:r&&(i=r[1]),!i)return;const o=De(0,i);if(!o)return;e.style.position="relative",e.appendChild(o),e.classList.add(v),e.setAttribute("data-ythwv-video-id",i),F(/yt-thumbnail.*not.*yt-hwv-has-eye-button/i);const a=G(e,b.VIDEO_CONTAINERS.join(", "));a&&a.setAttribute("data-ythwv-video-id",i),ge([i]).then(()=>{const t=x(i);if(t&&a&&He(a,t.state),!t||t.title)return;const n=G(e,b.VIDEO_CONTAINERS.join(", "));n&&n.setAttribute("data-ythwv-video-id",i);const s=J(n);s&&"Toggle video visibility"!==s&&async function(e,t,n=null){e&&Ee(e,t,n||void 0)}(i,t.state,s)}).catch(e=>{ae("EyeButtonManager",e,{operation:"fetchHiddenVideoStates",videoId:i})}),R()}),document.querySelectorAll(`.${y}`).forEach(e=>{const t=e.closest('[aria-hidden="true"]');t&&t.removeAttribute("aria-hidden")})}function xe(e){if(e&&e.type)return"updated"===e.type&&e.record?(D(e.record.videoId,e.record),document.querySelectorAll(`.${y}`).forEach(t=>{t.dataset.videoId===e.record.videoId&&Ne(t,e.record.state)}),void Le()):"removed"===e.type&&e.videoId?(D(e.videoId,null),document.querySelectorAll(`.${y}`).forEach(t=>{t.dataset.videoId===e.videoId&&Ne(t,"normal")}),void Le()):void("cleared"===e.type&&(N.clear(),document.querySelectorAll(`.${y}`).forEach(e=>{Ne(e,"normal")}),Le()))}async function Ce(){R(),ne(),ie(),_e(),await Le()}let Me=null;function Ve(){var e;chrome.runtime.onMessage.addListener((e,t)=>((async()=>{"settingsUpdated"===e.action||"resetSettings"===e.action?(await H(),await Ce()):"HIDDEN_VIDEOS_EVENT"===e.type&&xe(e.event)})().catch(e=>{console.error("Error handling message in content script:",e)}),!1)),document.addEventListener("yt-hwv-individual-update",()=>{Le()}),S.ENABLE_LAZY_PROCESSING?(e=({becameVisible:e,becameHidden:t})=>{e.length>0&&(R(e.length),Le())},we.add(e),Me=()=>we.delete(e)):R()}function ke(){Me&&(Me(),Me=null)}function Ye(e,t){let n;const i=function(...i){clearTimeout(n),n=setTimeout(()=>e.apply(this,i),t)};return i.cancel=function(){clearTimeout(n),n=null},i}let qe=null,ze=null,Pe=[];function Be(e=null){if(!qe)return void R();const t=e||X(E.VIDEO_CONTAINERS);t.forEach(e=>{try{qe.observe(e)}catch(e){R()}}),R(t.length)}function We(){return S.ENABLE_LAZY_PROCESSING?(Ue(),qe=function(){const e={root:null,rootMargin:S.ROOT_MARGIN,threshold:S.THRESHOLD};ze=Ye(()=>{Pe.length>0&&(Ae([...Pe]),Pe.length=0)},S.BATCH_DELAY);const t=new IntersectionObserver(e=>{Pe.push(...e),ze()},e);return R(),t}(),Be(),qe):(R(),null)}function Ue(){qe&&(qe.disconnect(),qe=null,Te.clear(),R()),Pe.length=0,ze&&"function"==typeof ze.cancel&&ze.cancel(),ze=null}function $e(e){const t=Ye(e,250),n=new MutationObserver(e=>{let n=!1,i=!1,s=!1;const r=[],o=[];var a;if(e.forEach(e=>{if("attributes"===e.type&&"aria-hidden"===e.attributeName){const t=e.target;"true"===t.getAttribute("aria-hidden")&&t.querySelector(`.${y}`)&&t.removeAttribute("aria-hidden")}else"childList"===e.type&&(n=!0,e.removedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){!function(e){if(!e)return;const t=P.get(e);t&&t.clear();const n=B.get(e);n&&n.clear();const i=W.get(e);i&&i.clear(),P.delete(e),B.delete(e),W.delete(e),$.invalidations++}(e);e.matches&&(e.matches("ytd-rich-item-renderer")||e.matches("ytd-video-renderer")||e.matches("ytd-grid-video-renderer")||e.matches("ytd-compact-video-renderer"))&&(i=!0,o.push(e))}}),e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){e.matches&&(e.matches("ytd-rich-item-renderer")||e.matches("ytd-video-renderer")||e.matches("ytd-grid-video-renderer")||e.matches("ytd-compact-video-renderer"))&&(i=!0,r.push(e));e.matches&&(e.matches("ytd-browse")||e.matches("ytd-watch-flexy")||e.matches("ytd-search"))&&(s=!0)}}))}),r.length>0&&Be(r),o.length>0&&(a=o,qe&&a.forEach(e=>{try{qe.unobserve(e)}catch(e){R()}})),s?K():i&&[/ytd-rich-item-renderer/,/ytd-video-renderer/,/ytd-grid-video-renderer/,/ytd-compact-video-renderer/,/yt-thumbnail/,/progress.*bar/i,/watch\?v=/,/shorts\//].forEach(e=>{F(e)}),n){if(1===e.length&&(e[0].target.classList?.contains(l)||e[0].target.classList?.contains(d)||e[0].target.classList?.contains(u)||e[0].target.classList?.contains(h)))return;t()}});return n.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["aria-hidden"]}),n}function Ge(e){const t=Ye(e,100);let n=location.href;const i=new MutationObserver(()=>{const e=location.href;e!==n&&(K(),Ue(),We(),n=e,setTimeout(t,100))});return i.observe(document,{subtree:!0,childList:!0}),i}const je=new Map;function Xe(){setInterval(()=>{!function(){const e=q();e.length>0&&Fe(e)}()},I)}function Fe(e){for(const{key:t,health:n}of e){const e=je.get(t),i=Date.now();if(e&&i-e<A)continue;const s=Ke(n.successRate);"critical"===s?(Ze(t,n),je.set(t,i)):"warning"===s&&(Qe(t,n),je.set(t,i))}}function Ke(e){return e<.3?"critical":e<.7?"warning":"ok"}function Ze(e,t){console.error("[YT-HWV] Critical selector failure:","selector:",e,"successRate:",t.successRate,"queries:",t.queries),ye("YouTube structure changed. Some videos may not be detected. Please report this issue.",he,8e3)}function Qe(e,t){console.warn("[YT-HWV] Selector degradation:","selector:",e,"successRate:",t.successRate),ye("Extension may not detect all videos. YouTube might have changed their layout.",ue,5e3)}async function Je(){try{await async function(e=10,t=500){for(let n=1;n<=e;n++){try{const e=await le(o,{});if(e&&e.ready)return!0;e&&e.error&&ae("ContentInit",new Error("Background initialization error: "+e.error))}catch(t){ae("ContentInit",t,{attempt:n,maxAttempts:e,message:"Health check failed, retrying..."})}n<e&&await new Promise(e=>setTimeout(e,t))}return!1}()||console.warn("[YT-HWV] Background script not ready, starting with limited functionality. Individual video hiding/dimming may not work until background service is ready.");try{e()}catch(e){throw ae("ContentInit",e,{component:"styles",fatal:!0}),"undefined"!=typeof document&&document.body&&ye("YouTube Hide Watched Videos failed to load styles","error",5e3),e}await H(),z(),Xe(),await Ce(),We(),$e(Ce),function(e){const t=Ye(e,100),n=XMLHttpRequest.prototype.open,i=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(e,t){return this._url=t,n.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){return this.addEventListener("readystatechange",function(){4===this.readyState&&this._url&&(this._url.includes("browse_ajax")||this._url.includes("browse?"))&&setTimeout(t,100)}),i.apply(this,arguments)}}(Ce),Ge(Ce),Ve()}catch(e){ae("ContentInit",e,{fatal:!0}),"undefined"!=typeof document&&document.body&&ye("YouTube Hide Watched Videos extension failed to initialize","error",5e3)}}"undefined"!=typeof window&&(window.YTHWV_TestDOMHealth=function(){const e=q();return 0===e.length?(ye("All DOM selectors are healthy",me,3e3),!0):(Fe(e),!1)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Je):Je(),"undefined"!=typeof window&&(window.addEventListener("beforeunload",()=>{Ue(),ke()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&Ue()}),window.addEventListener("pagehide",()=>{Ue(),ke()})),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onSuspend?.addListener(()=>{Ue(),ke()}),R()})();
//# sourceMappingURL=content.js.map